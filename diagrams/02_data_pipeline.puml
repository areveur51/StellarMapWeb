@startuml 02_data_pipeline

skinparam backgroundColor #261D45
skinparam activity {
    BackgroundColor #100D23
    BorderColor #0BE784
    FontColor #96DDF2
}
skinparam activityArrowColor #01C176
skinparam activityStartColor #0BE784
skinparam activityStopColor #E5526F
skinparam activityDiamondBackgroundColor #231B3D
skinparam activityDiamondBorderColor #0BE784
skinparam defaultFontColor #96DDF2
skinparam note {
  BackgroundColor #231B3D
  BorderColor #3f2c70
  FontColor #96DDF2
}

title <color:#0BE784>Data Collection Pipeline - Permanent Storage Architecture

partition "<color:#0BE784>BigQuery Pipeline (Primary - Permanent Storage)" {
  start
  
  :User Searches Address;
  
  if (<color:#0BE784>Lineage in Cassandra?) then (yes)
    note right #231B3D
      <color:#0BE784>REPEAT SEARCH
      <color:#96DDF2>• <1 second response
      <color:#96DDF2>• 0 BigQuery cost
      <color:#96DDF2>• Cached lineage
    end note
    
    :Read Lineage from Cassandra;
    
  else (no)
    note right #231B3D
      <color:#E5526F>FIRST-TIME SEARCH
      <color:#96DDF2>• 50-90 second response
      <color:#96DDF2>• ~265 MB BigQuery usage
      <color:#96DDF2>• Permanent storage
    end note
    
    :Query 1: Account Creation Date;
    note right #231B3D
      <color:#96DDF2>From <color:#0BE784>accounts_current
      <color:#96DDF2>Creation timestamp
    end note
    
    :Query 2: Creator Discovery;
    note right #231B3D
      <color:#96DDF2>From <color:#0BE784>enriched_history_operations
      <color:#96DDF2>Find parent (type=0)
    end note
    
    :Query 3: Child Accounts;
    note right #231B3D
      <color:#96DDF2>Paginated (10K batches)
      <color:#96DDF2>Up to 100K children
      <color:#96DDF2>Handles airdrops
    end note
    
    :Store Lineage in Cassandra;
    note right #231B3D
      <color:#0BE784>PERMANENT STORAGE
      <color:#96DDF2>• Never re-query BigQuery
      <color:#96DDF2>• Free forever
      <color:#96DDF2>• Costs decrease over time
    end note
  endif
  
  :API: Refresh Enrichment Data;
  note right #231B3D
    <color:#96DDF2>From <color:#0BE784>Horizon API
    <color:#96DDF2>Balance, flags, home_domain
    <color:#96DDF2>
    <color:#96DDF2>From <color:#0BE784>Stellar Expert
    <color:#96DDF2>Current assets, trustlines
    <color:#96DDF2>
    <color:#E5526F>Every search (always fresh)
  end note
  
  :Return Complete Data to User;
  
  stop
  
  note left #231B3D
    <color:#0BE784>Cost Model (Realistic):
    <color:#96DDF2>• 2,500 unique/month: <color:#0BE784>$0
    <color:#96DDF2>• 5,000 unique/month: <color:#0BE784>$1-5
    <color:#96DDF2>• Repeat searches: <color:#0BE784>FREE
    <color:#96DDF2>
    <color:#0BE784>Performance:
    <color:#96DDF2>• First-time: 50-90 sec
    <color:#96DDF2>• Repeat: <1 sec
    <color:#96DDF2>• No rate limits
  end note
}

partition "<color:#96DDF2>API Pipeline (Educational Reference - 2-3 minutes)" {
  start
  
  :User Searches Address;
  
  :Stage 1: Make Parent Lineage;
  
  :Stage 2: Collect Horizon Data;
  
  :Stage 3: Account Attributes;
  
  :Stage 4: Account Assets;
  
  :Stage 5: Account Flags;
  
  :Stage 6: SE Directory;
  note right #231B3D
    <color:#96DDF2>Stellar Expert enrichment
  end note
  
  :Stage 7: Account Creator;
  
  :Stage 8: Make Grandparent;
  
  stop
  
  note left #231B3D
    <color:#96DDF2>API Pipeline (Reference):
    <color:#96DDF2>• 8 sequential stages
    <color:#96DDF2>• Horizon + Expert APIs
    <color:#96DDF2>• Educational purposes
    <color:#96DDF2>• Not enabled by default
  end note
}

@enduml
