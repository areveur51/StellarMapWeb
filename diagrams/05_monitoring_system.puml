@startuml Monitoring System

skinparam backgroundColor #261D45
skinparam defaultFontColor #96DDF2

skinparam component {
  BackgroundColor #100D23
  BorderColor #0BE784
  FontColor #96DDF2
  ArrowColor #01C176
}

skinparam database {
  BackgroundColor #032314
  BorderColor #0BE784
  FontColor #96DDF2
}

skinparam package {
  BackgroundColor #231B3D
  BorderColor #3f2c70
  FontColor #96DDF2
}

skinparam note {
  BackgroundColor #100D23
  BorderColor #3f2c70
  FontColor #96DDF2
}

title <color:#0BE784>Monitoring & Health System</color>

package "Monitoring Components" #231B3D {
  component "Cron Health\nMonitor" as CronHealth
  component "Stuck Record\nRecovery" as Recovery
  component "Stage Execution\nTracker" as StageTracker
}

component "Cron Worker\n(run_cron_jobs.py)" as CronWorker

database "ManagementCronHealth\nTable" as HealthDB
database "Stage Execution\nTable" as StageDB
database "Cache & Lineage\nTables" as DataDB

CronWorker -[#01C176]-> CronHealth : "Checks before run"
CronHealth -[#01C176]-> HealthDB : "Reads status"

CronWorker -[#01C176]-> StageTracker : "Executes stages\n(if healthy)"
StageTracker -[#01C176]-> StageDB : "Updates progress"

CronHealth -[#E5526F]-> CronWorker : "Skips processing\n(if unhealthy)"

Recovery -[#01C176]-> DataDB : "Finds stuck records"
Recovery -[#01C176]-> DataDB : "Resets to PENDING"

note right of CronHealth #100D23
  <color:#0BE784>Health Statuses:</color>
  <color:#96DDF2>• HEALTHY</color>
  <color:#E5526F>• UNHEALTHY_RATE_LIMITED</color>
  
  <color:#0BE784>Recovery:</color>
  <color:#96DDF2>Manual cleanup required
  via .allow_filtering()</color>
end note

note right of Recovery #231B3D
  <color:#0BE784>Stuck Thresholds:</color>
  <color:#96DDF2>Detects records stuck in:
  • PENDING
  • IN_PROGRESS</color>
  
  <color:#0BE784>Terminal Statuses</color>
  <color:#96DDF2>(Never recovered):</color>
  <color:#E5526F>• FAILED
  • INVALID_HORIZON_STELLAR_ADDRESS</color>
end note

note right of StageTracker #100D23
  <color:#0BE784>Stage Lifecycle:</color>
  <color:#96DDF2>1. Initialize all 8 stages
  2. Update status per stage
  3. Track execution time
  4. Log errors
  5. Display in UI</color>
end note

@enduml
