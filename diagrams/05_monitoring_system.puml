@startuml Monitoring System

skinparam backgroundColor #261D45
skinparam defaultFontColor #96DDF2

skinparam component {
  BackgroundColor #100D23
  BorderColor #0BE784
  FontColor #96DDF2
  ArrowColor #01C176
}

skinparam database {
  BackgroundColor #100D23
  BorderColor #0BE784
  FontColor #96DDF2
}

skinparam package {
  BackgroundColor #231B3D
  BorderColor #3f2c70
  FontColor #96DDF2
}

skinparam note {
  BackgroundColor #231B3D
  BorderColor #3f2c70
  FontColor #96DDF2
}

title <color:#0BE784>Monitoring & Health System

package "Monitoring Components" #231B3D {
  component "Health\nMonitor" as HealthMonitor
  component "Stuck Record\nRecovery" as Recovery
  component "Progress\nTracker" as ProgressTracker
}

component "BigQuery Pipeline\n(Primary)" as BQPipeline
component "API Pipeline\n(Educational)" as APIPipeline

database "ManagementCronHealth\nTable" as HealthDB
database "Progress Tracking\nTable" as ProgressDB
database "Cache & Lineage\nTables" as DataDB

BQPipeline -[#0BE784]-> ProgressTracker : "Tracks processing"
APIPipeline -[#96DDF2,dashed]-> ProgressTracker : "(If enabled)"

ProgressTracker -[#01C176]-> ProgressDB : "Updates status"

HealthMonitor -[#01C176]-> HealthDB : "Monitors health"
HealthMonitor -[#01C176]-> BQPipeline : "Checks BigQuery"
HealthMonitor -[#96DDF2,dashed]-> APIPipeline : "(If enabled)"

Recovery -[#01C176]-> DataDB : "Finds stuck records"
Recovery -[#01C176]-> DataDB : "Resets to PENDING"

note right of BQPipeline #231B3D
  <color:#0BE784>BigQuery Pipeline:
  <color:#96DDF2>• 50-90 second processing
  <color:#96DDF2>• No rate limits
  <color:#96DDF2>• Continuous operation
  <color:#96DDF2>• Up to 100 accounts/batch
end note

note right of APIPipeline #231B3D
  <color:#96DDF2>API Pipeline (Reference):
  <color:#96DDF2>• 8 sequential stages
  <color:#96DDF2>• Educational purposes
  <color:#96DDF2>• Not enabled by default
end note

note right of HealthMonitor #231B3D
  <color:#0BE784>Health Statuses:
  <color:#96DDF2>• HEALTHY
  <color:#E5526F>• UNHEALTHY_RATE_LIMITED
  
  <color:#0BE784>Recovery:
  <color:#96DDF2>Manual cleanup required
  via .allow_filtering()
end note

note right of Recovery #231B3D
  <color:#0BE784>Stuck Thresholds:
  <color:#96DDF2>Detects records stuck in:
  • PENDING
  • IN_PROGRESS
  
  <color:#0BE784>Terminal Statuses:
  <color:#96DDF2>(Never recovered)
  <color:#E5526F>• FAILED
  • INVALID_HORIZON_STELLAR_ADDRESS
end note

note right of ProgressTracker #231B3D
  <color:#0BE784>Tracking Features:
  <color:#96DDF2>1. Real-time status updates
  2. Execution time logging
  3. Error tracking
  4. UI display
  5. JSON viewer support
end note

@enduml
