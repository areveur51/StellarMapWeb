@startuml 05_monitoring_system

skinparam backgroundColor #261D45
skinparam defaultFontColor #96DDF2

top to bottom direction

skinparam component {
  BackgroundColor #100D23
  BorderColor #0BE784
  FontColor #96DDF2
  ArrowColor #01C176
}

skinparam database {
  BackgroundColor #100D23
  BorderColor #0BE784
  FontColor #96DDF2
}

skinparam note {
  BackgroundColor #231B3D
  BorderColor #3f2c70
  FontColor #96DDF2
}

title <color:#0BE784>Monitoring & Health System

component "BigQuery Pipeline" as BQPipeline
component "API Pipeline" as APIPipeline
component "Progress Tracker" as ProgressTracker
database "Progress DB" as ProgressDB

component "Health Monitor" as HealthMonitor
database "Health DB" as HealthDB

component "Stuck Record Recovery" as Recovery
database "Cache & Lineage DB" as DataDB

component "API Rate Limiter" as RateLimiter
database "Django Cache" as CacheDB

component "Dashboard Metrics" as Dashboard

BQPipeline -down-> ProgressTracker
APIPipeline -down-> ProgressTracker
ProgressTracker -down-> ProgressDB

HealthMonitor -down-> HealthDB
HealthMonitor -up-> BQPipeline : "monitors"
HealthMonitor -up-> APIPipeline : "monitors"

Recovery -down-> DataDB : "finds stuck\nresets PENDING"

RateLimiter -down-> CacheDB
RateLimiter -up-> APIPipeline : "controls"
RateLimiter -up-> BQPipeline : "age filter"

Dashboard -up-> HealthDB : "reads"
Dashboard -up-> CacheDB : "reads"
Dashboard -up-> DataDB : "reads"

note right of BQPipeline
  <color:#0BE784>BigQuery Pipeline
  <color:#96DDF2>• 50-90s processing
  <color:#96DDF2>• No rate limits
  <color:#96DDF2>• Age filter <2 years
  <color:#0BE784>• Up to 100/batch
end note

note right of HealthMonitor
  <color:#0BE784>Health Statuses
  <color:#96DDF2>• HEALTHY
  <color:#E5526F>• UNHEALTHY_RATE_LIMITED
end note

note right of Recovery
  <color:#0BE784>Stuck Thresholds
  <color:#96DDF2>• PENDING >2 hours
  <color:#96DDF2>• IN_PROGRESS stuck
  <color:#E5526F>• Never recovers FAILED
end note

note right of Dashboard
  <color:#0BE784>Dashboard Sections
  <color:#96DDF2>1. Alerts (top)
  <color:#96DDF2>2. API Health
  <color:#96DDF2>3. BigQuery Costs
  <color:#96DDF2>4. Database Health
  <color:#96DDF2>5. Performance
end note

@enduml
