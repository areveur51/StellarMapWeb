@startuml 10_pipeline_execution_workflow

skinparam backgroundColor #261D45
skinparam defaultFontColor #96DDF2

skinparam rectangle {
  BackgroundColor #100D23
  BorderColor #0BE784
  FontColor #96DDF2
  ArrowColor #01C176
}

skinparam package {
  BackgroundColor #231B3D
  BorderColor #3f2c70
  FontColor #96DDF2
}

skinparam note {
  BackgroundColor #231B3D
  BorderColor #3f2c70
  FontColor #96DDF2
}

title <color:#0BE784>Pipeline Execution Workflow\n<color:#96DDF2>Creator & Child Account Queueing

top to bottom direction

rectangle "1. Queue Sync\n(Pre-Processing)" as QueueSync #100D23
rectangle "2. Fetch Account\nfrom Lineage Table" as Fetch #100D23
rectangle "3. Process Account\n(BigQuery/API)" as Process #100D23
rectangle "4. Extract Data\n(Creator, Children, Balance)" as Extract #100D23
rectangle "5. Update Lineage\nDatabase Record" as Update #100D23
rectangle "6. Queue Creator\n(if new)" as QueueCreator #100D23
rectangle "7. Queue Children\n(if new)" as QueueChildren #100D23
rectangle "8. Sync Status Back\nto Search Cache" as SyncBack #100D23
rectangle "9. Graph Expansion\n(Count Increases)" as Expansion #231B3D

QueueSync -[#01C176]-> Fetch
Fetch -[#01C176]-> Process
Process -[#01C176]-> Extract
Extract -[#01C176]-> Update
Update -[#01C176]-> QueueCreator
Update -[#01C176]-> QueueChildren
QueueCreator -[#01C176]-> SyncBack
QueueChildren -[#01C176]-> SyncBack
SyncBack -[#01C176]-> Expansion
Expansion -[#96DDF2,dashed]-> Fetch : "<color:#96DDF2>Next pipeline run\nprocesses queue"

note right of QueueSync #231B3D
  <color:#0BE784>Pre-Processing:
  <color:#96DDF2>• Search Cache → Lineage
  <color:#96DDF2>• Promote PENDING records
  <color:#96DDF2>• Single-account searches only
  <color:#0BE784>• Bulk Search bypasses cache
end note

note right of Process #231B3D
  <color:#0BE784>Dual Pipeline:
  <color:#96DDF2>• BigQuery (50-90s)
  <color:#96DDF2>• API (180-300s)
  <color:#96DDF2>• Horizon API + Stellar Expert
  <color:#0BE784>• Tenacity retry logic
end note

note right of QueueCreator #231B3D
  <color:#0BE784>Creator Queueing:
  <color:#96DDF2>• Check if creator exists
  <color:#96DDF2>• If NEW → Create PENDING
  <color:#96DDF2>• If exists → Skip
  <color:#0BE784>• Builds lineage upward
end note

note right of QueueChildren #231B3D
  <color:#0BE784>Child Queueing:
  <color:#96DDF2>• For each discovered child
  <color:#96DDF2>• Check if exists
  <color:#96DDF2>• If NEW → Create PENDING
  <color:#96DDF2>• Set parent relationship
  <color:#0BE784>• Builds lineage downward
end note

note right of SyncBack #231B3D
  <color:#0BE784>Status Mapping:
  <color:#96DDF2>API_COMPLETE →
  <color:#96DDF2>  DONE_MAKE_PARENT_LINEAGE
  <color:#96DDF2>BIGQUERY_COMPLETE →
  <color:#96DDF2>  DONE_MAKE_PARENT_LINEAGE
  <color:#E5526F>FAILED → FAILED
end note

note right of Expansion #231B3D
  <color:#0BE784>Continuous Expansion:
  <color:#96DDF2>• New accounts queued
  <color:#96DDF2>• Lineage count increases
  <color:#96DDF2>• Graph grows organically
  <color:#96DDF2>• Upward (creators)
  <color:#96DDF2>• Downward (children)
  <color:#0BE784>• No duplicate queueing
end note

@enduml
