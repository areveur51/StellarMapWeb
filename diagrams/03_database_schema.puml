@startuml 03_database_schema

skinparam backgroundColor #261D45
skinparam defaultFontColor #96DDF2

top to bottom direction

skinparam class {
  BackgroundColor #100D23
  BorderColor #0BE784
  FontColor #96DDF2
  ArrowColor #01C176
}

skinparam note {
  BackgroundColor #231B3D
  BorderColor #3f2c70
  FontColor #96DDF2
}

title <color:#0BE784>Astra DB (Cassandra) Schema

class StellarAccountSearchCache {
  <color:#0BE784>+ stellar_account (PK)
  <color:#0BE784>+ network_name (PK)
  <color:#96DDF2>+ status
  + cached_json
  + last_fetched_at
  + retry_count
  --
  <color:#01C176>12-hour cache
}

class StellarCreatorAccountLineage {
  <color:#0BE784>+ id (PK)
  <color:#0BE784>+ stellar_account (CK)
  <color:#0BE784>+ network_name (CK)
  <color:#96DDF2>+ stellar_creator_account
  + xlm_balance
  + is_hva
  + status
  + num_child_accounts
  + pipeline_source
  --
  <color:#01C176>Main lineage table
}

class HVAStandingChange {
  <color:#0BE784>+ stellar_account (PK)
  <color:#0BE784>+ change_time (CK)
  <color:#96DDF2>+ event_type
  + old_rank
  + new_rank
  + old_balance
  + new_balance
  + xlm_threshold
  --
  <color:#01C176>Ranking history
}

class StellarAccountStageExecution {
  <color:#0BE784>+ stellar_account (PK)
  <color:#0BE784>+ network_name (PK)
  <color:#0BE784>+ stage_number (CK)
  <color:#96DDF2>+ status
  + execution_time_ms
  + error_message
  --
  <color:#01C176>Pipeline tracking
}

class BigQueryPipelineConfig {
  <color:#0BE784>+ config_id (PK)
  <color:#96DDF2>+ bigquery_enabled
  + cost_limit_usd
  + pipeline_mode
  + hva_threshold
  + batch_size
  --
  <color:#01C176>Admin settings
}

StellarAccountSearchCache -down-> StellarCreatorAccountLineage : "syncs to"
StellarCreatorAccountLineage -down-> HVAStandingChange : "tracks changes"
StellarCreatorAccountLineage -down-> StellarAccountStageExecution : "pipeline stages"

note right of StellarAccountSearchCache
  <color:#0BE784>Search Cache
  <color:#96DDF2>• 12-hour TTL
  <color:#96DDF2>• Status filtering
  <color:#96DDF2>• Queue sync to Lineage
end note

note right of StellarCreatorAccountLineage
  <color:#0BE784>Dual Pipeline Source
  <color:#96DDF2>• BigQuery (primary)
  <color:#96DDF2>• API (fallback)
  <color:#96DDF2>• HVA tagging
  <color:#96DDF2>• Creator/child tracking
end note

note right of HVAStandingChange
  <color:#0BE784>Multi-Threshold Ranking
  <color:#96DDF2>• 10K-1M XLM thresholds
  <color:#96DDF2>• Event-based tracking
  <color:#96DDF2>• ENTERED/EXITED/RANK_UP
  <color:#0BE784>• 480x storage efficiency
end note

note right of BigQueryPipelineConfig
  <color:#0BE784>Dynamic Configuration
  <color:#96DDF2>• Admin configurable
  <color:#96DDF2>• Multiple thresholds
  <color:#96DDF2>• Cost limits
end note

@enduml
