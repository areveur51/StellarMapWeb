@startuml 03_database_schema

skinparam backgroundColor #261D45
skinparam defaultFontColor #96DDF2

skinparam class {
  BackgroundColor #100D23
  BorderColor #0BE784
  FontColor #96DDF2
  ArrowColor #01C176
}

skinparam note {
  BackgroundColor #231B3D
  BorderColor #3f2c70
  FontColor #96DDF2
}

title <color:#0BE784>Astra DB (Cassandra) Schema

top to bottom direction

class StellarAccountSearchCache {
  <color:#0BE784>+ stellar_account (PK)
  <color:#0BE784>+ network_name (PK)
  <color:#96DDF2>+ status
  + cached_json
  + last_fetched_at
  + retry_count
  + created_at
  + updated_at
  --
  <color:#01C176>12-hour cache
}

class StellarCreatorAccountLineage {
  <color:#0BE784>+ id (PK)
  <color:#0BE784>+ stellar_account (CK)
  <color:#0BE784>+ network_name (CK)
  <color:#0BE784>+ created_at (CK)
  <color:#96DDF2>+ stellar_creator_account
  + stellar_account_created_at
  + home_domain
  + xlm_balance
  + is_hva
  + tags
  + status
  + num_child_accounts
  + pipeline_source
  + processing_started_at
  --
  <color:#01C176>Lineage + HVA flag
}

class StellarAccountStageExecution {
  <color:#0BE784>+ stellar_account (PK)
  <color:#0BE784>+ network_name (PK)
  <color:#0BE784>+ created_at (PK)
  <color:#0BE784>+ stage_number (CK)
  <color:#96DDF2>+ cron_name
  + status
  + execution_time_ms
  + error_message
  + updated_at
  --
  <color:#01C176>Pipeline tracking
}

class HVAStandingChange {
  <color:#0BE784>+ stellar_account (PK)
  <color:#0BE784>+ change_time (CK)
  <color:#96DDF2>+ event_type
  + old_rank
  + new_rank
  + old_balance
  + new_balance
  + rank_change
  + network_name
  + xlm_threshold
  + created_at
  --
  <color:#01C176>Multi-threshold ranking
}

class BigQueryPipelineConfig {
  <color:#0BE784>+ config_id (PK)
  <color:#96DDF2>+ bigquery_enabled
  + cost_limit_usd
  + pipeline_mode
  + hva_threshold
  + hva_supported_thresholds
  + batch_size
  + cache_ttl_hours
  + created_at
  + updated_at
  --
  <color:#01C176>Admin settings
}

note right of StellarAccountSearchCache #231B3D
  <color:#0BE784>Optimized Queries:
  <color:#96DDF2>filter(status__in=[
    'PENDING',
    'IN_PROGRESS',
    'RE_INQUIRY'
  ])
end note

note right of StellarCreatorAccountLineage #231B3D
  <color:#0BE784>Dual Pipeline:
  <color:#96DDF2>Primary: <color:#0BE784>BigQuery
  <color:#96DDF2>• Account data
  <color:#96DDF2>• Assets
  <color:#96DDF2>• Creator info
  <color:#96DDF2>• Child accounts
  <color:#96DDF2>• HVA tagging
  
  <color:#96DDF2>Fallback: <color:#96DDF2>API Pipeline
end note

note right of HVAStandingChange #231B3D
  <color:#0BE784>Multi-Threshold:
  <color:#96DDF2>• Tracks per threshold
  <color:#96DDF2>• xlm_threshold column
  <color:#96DDF2>• Network filtering
  <color:#96DDF2>• Event types: ENTERED,
  <color:#96DDF2>  EXITED, RANK_UP,
  <color:#96DDF2>  RANK_DOWN
  
  <color:#0BE784>480x storage efficiency
end note

note right of BigQueryPipelineConfig #231B3D
  <color:#0BE784>Dynamic Config:
  <color:#96DDF2>• Default: 100K XLM
  <color:#96DDF2>• Supported thresholds:
  <color:#96DDF2>  10K, 50K, 100K,
  <color:#96DDF2>  500K, 750K, 1M
  <color:#96DDF2>• Admin customizable
end note

@enduml
