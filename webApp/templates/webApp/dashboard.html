{% load static %}

<!DOCTYPE html>
<html>
<head>
  <title>StellarMap Web - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Global theme loader - syncs with admin portal theme -->
  <script src="{% static 'webApp/js/global_theme_loader.js' %}"></script>
  <script src="{% static 'webApp/js/theme_sync.js' %}"></script>
  <link rel="stylesheet" type="text/css" href="{% static 'webApp/css/frontend.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" crossorigin="anonymous">
  
  <style>
    /* Cyberpunk theme colors */
    .dashboard-container {
        padding: 10px;
        background: #261D45; /* Main cyberpunk purple background */
        min-height: 100vh;
        color: #96DDF2; /* Cyberpunk cyan text */
        max-width: 100%;
        width: 100%;
    }
    .stat-card {
        background: linear-gradient(135deg, #231B3D 0%, #1a1530 100%); /* Subtle gradient */
        border: 1px solid #3f2c70; /* Cyberpunk purple border */
        border-radius: 6px;
        padding: 15px 12px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        /* Fixed square size */
        width: 180px;
        height: 180px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(150, 221, 242, 0.1), transparent);
        transition: left 0.5s ease;
    }
    .stat-card:hover::before {
        left: 100%;
    }
    .stat-card:hover {
        transform: translateY(-3px) scale(1.02);
        border-color: #96DDF2; /* Cyberpunk cyan on hover */
        box-shadow: 0 8px 30px rgba(150, 221, 242, 0.4), 
                    0 0 20px rgba(150, 221, 242, 0.2),
                    inset 0 0 30px rgba(150, 221, 242, 0.05);
    }
    .stat-value {
        font-size: 2.8rem;
        font-weight: 700;
        color: #96DDF2; /* Cyberpunk cyan for values */
        word-wrap: break-word;
        overflow-wrap: break-word;
        margin: 8px 0;
        text-shadow: 0 0 15px rgba(150, 221, 242, 0.5), 0 0 30px rgba(150, 221, 242, 0.2);
        position: relative;
        z-index: 1;
        line-height: 1.1;
        letter-spacing: -1px;
        max-width: 100%;
        hyphens: auto;
    }
    /* Responsive text sizing for long status values */
    .stat-value-responsive {
        font-size: 1rem !important;
        line-height: 1.2;
        word-break: break-word;
        hyphens: auto;
        overflow-wrap: break-word;
        padding: 0 5px;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    /* Single-line status values - large and centered */
    .stat-value-nowrap {
        font-size: 2.4rem !important;
        line-height: 1;
        white-space: normal !important;
        word-wrap: break-word;
        max-width: 100%;
        padding: 0 5px;
    }
    .stat-label {
        color: #c4b5fd; /* Light purple for labels */
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        line-height: 1.2;
        font-weight: 500;
    }
    .stat-card small {
        display: block;
        word-wrap: break-word;
        overflow-wrap: break-word;
        color: #a78bfa; /* Muted purple for small text */
        font-size: 0.7rem;
        margin-top: 8px;
        line-height: 1.3;
        opacity: 0.85;
    }
    .admin-link-btn {
        margin-top: 10px;
        font-size: 0.65rem;
        padding: 5px 12px;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
        white-space: nowrap;
        border-radius: 3px;
        font-weight: 500;
    }
    .admin-link-btn:hover {
        transform: scale(1.08);
        box-shadow: 0 0 15px currentColor;
    }
    /* Centered grid for fixed-size square cards */
    .dashboard-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    /* Override Bootstrap button hover states with cyberpunk colors */
    .btn-outline-info:hover,
    .btn-outline-info:focus,
    .btn-outline-info:active {
        background-color: rgba(150, 221, 242, 0.1) !important;
        border-color: #96DDF2 !important;
        color: #96DDF2 !important;
    }
    .btn-outline-success:hover,
    .btn-outline-success:focus,
    .btn-outline-success:active {
        background-color: rgba(11, 231, 132, 0.1) !important;
        border-color: #0BE784 !important;
        color: #0BE784 !important;
    }
    .btn-outline-warning:hover,
    .btn-outline-warning:focus,
    .btn-outline-warning:active {
        background-color: rgba(255, 193, 7, 0.1) !important;
        border-color: #ffc107 !important;
        color: #ffc107 !important;
    }
    .btn-outline-danger:hover,
    .btn-outline-danger:focus,
    .btn-outline-danger:active {
        background-color: rgba(229, 82, 111, 0.1) !important;
        border-color: #E5526F !important;
        color: #E5526F !important;
    }
    .section-title {
        color: #0BE784; /* Cyberpunk green accent */
        margin-bottom: 12px;
        margin-top: 20px;
        padding-bottom: 8px;
        border-bottom: 2px solid #3f2c70; /* Cyberpunk purple border */
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-weight: 700;
        position: relative;
        text-shadow: 0 0 10px rgba(11, 231, 132, 0.3);
    }
    .section-title::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 80px;
        height: 2px;
        background: linear-gradient(90deg, #0BE784, transparent);
        box-shadow: 0 0 10px rgba(11, 231, 132, 0.5);
    }
    .health-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 4px;
        position: relative;
    }
    /* Keep original indicator colors */
    .health-good { 
        background-color: #0BE784; /* Cyberpunk green */
        box-shadow: 0 0 6px rgba(11, 231, 132, 0.6);
    }
    .health-warning { 
        background-color: #ffc107; /* Yellow */
        box-shadow: 0 0 6px rgba(255, 193, 7, 0.6);
        animation: pulse-warning 2s infinite;
    }
    .health-danger { 
        background-color: #E5526F; /* Cyberpunk red */
        box-shadow: 0 0 6px rgba(229, 82, 111, 0.6);
        animation: pulse-danger 1.5s infinite;
    }
    @keyframes pulse-warning {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    @keyframes pulse-danger {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
    }
    .alert-custom {
        background: linear-gradient(135deg, #100D23 0%, #1a1530 100%); /* Dark cyberpunk gradient */
        border-left: 3px solid #3f2c70; /* Accent border */
        border-top: 1px solid #3f2c70;
        border-right: 1px solid #3f2c70;
        border-bottom: 1px solid #3f2c70;
        color: #96DDF2; /* Cyberpunk cyan text */
        padding: 6px 10px;
        margin-bottom: 6px;
        font-size: 0.8rem;
        border-radius: 3px;
        position: relative;
    }
    .alert-custom.alert-warning {
        border-left-color: #ffc107;
    }
    .alert-custom.alert-danger {
        border-left-color: #E5526F;
    }
    .alert-custom.alert-success {
        border-left-color: #0BE784;
    }
    /* Reduce Bootstrap row gutters for tighter layout */
    .row {
        margin-left: -8px;
        margin-right: -8px;
    }
    .row > [class*="col-"] {
        padding-left: 8px;
        padding-right: 8px;
    }
  </style>
</head>
<body class="bg-color-261D45">
  <div id="app">
    <!-- Include shared search container and sidebar -->
    {% include 'webApp/search_container_include.html' %}

    <div class="dashboard-container">
        <h1 class="text-center mb-2" style="font-size: 1.4rem; margin-top: 0; text-shadow: 0 0 15px rgba(150, 221, 242, 0.4); font-weight: 600; letter-spacing: 1px;">
            System Dashboard
        </h1>
        
        <!-- Alerts and Recommendations -->
        <h3 class="section-title">
                    Alerts & Recommendations
                </h3>
        <div class="dashboard-grid">
            <div class="col-12">
                {% if db_stats.stuck_accounts > 0 %}
                <div class="alert alert-custom alert-warning">
                    <strong>Stuck Records Alert:</strong>
                    {{ db_stats.stuck_accounts }} accounts are stuck in processing. Check cron jobs and pipeline health.
                </div>
                {% endif %}
                
                {% if db_stats.orphan_accounts > 0 %}
                <div class="alert alert-custom alert-warning">
                    <strong>Data Integrity Warning:</strong>
                    {{ db_stats.orphan_accounts }} accounts in cache have no lineage data. Consider re-processing.
                </div>
                {% endif %}
                
                {% if stage_health.failed_stages > 0 %}
                <div class="alert alert-custom alert-danger">
                    <strong>Pipeline Failures:</strong>
                    {{ stage_health.failed_stages }} stage executions have failed. Check logs for error details.
                </div>
                {% endif %}
                
                {% if bigquery_stats.estimated_monthly_cost > 50 %}
                <div class="alert alert-custom alert-info">
                    <strong>Cost Alert:</strong>
                    Estimated monthly BigQuery cost is ${{ bigquery_stats.estimated_monthly_cost|floatformat:2 }}. 
                    Consider adjusting cost limits or reducing processing frequency.
                </div>
                {% endif %}
                
                {% if db_stats.stuck_accounts == 0 and db_stats.orphan_accounts == 0 and stage_health.failed_stages == 0 %}
                <div class="alert alert-custom alert-success">
                    <strong>All Systems Healthy:</strong>
                    No critical issues detected. System is operating normally.
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- API Health Monitoring -->
        <h3 class="section-title">
            API Health Monitoring
        </h3>
        <div class="dashboard-grid">
            <div>
                <div class="stat-card" title="Current Horizon API usage rate. Shows calls per minute with burst limit of 120 req/min. Rate limiter prevents API throttling.">
                    <div class="stat-label">Horizon API (Stellar)</div>
                    <div class="stat-value">
                        {% if api_health.horizon_calls_this_minute >= api_health.horizon_burst_limit %}
                            <span class="health-indicator health-danger"></span>
                        {% elif api_health.horizon_calls_this_minute >= api_health.horizon_burst_limit|add:"-10" %}
                            <span class="health-indicator health-warning"></span>
                        {% else %}
                            <span class="health-indicator health-good"></span>
                        {% endif %}
                        {{ api_health.horizon_calls_this_minute }}/{{ api_health.horizon_burst_limit }}
                    </div>
                    <small>calls/min ({{ api_health.horizon_rate_delay }}s delay)</small>
                    {% if api_health.horizon_last_call %}
                    <small style="display: block; margin-top: 4px;">Last: {{ api_health.horizon_last_call|slice:":19" }}</small>
                    {% endif %}
                </div>
            </div>
            <div>
                <div class="stat-card" title="Current Stellar Expert API usage rate. Shows calls per minute with burst limit of 50 req/min. Used for enrichment data.">
                    <div class="stat-label">Stellar Expert API</div>
                    <div class="stat-value">
                        {% if api_health.stellar_expert_calls_this_minute >= api_health.stellar_expert_burst_limit %}
                            <span class="health-indicator health-danger"></span>
                        {% elif api_health.stellar_expert_calls_this_minute >= api_health.stellar_expert_burst_limit|add:"-5" %}
                            <span class="health-indicator health-warning"></span>
                        {% else %}
                            <span class="health-indicator health-good"></span>
                        {% endif %}
                        {{ api_health.stellar_expert_calls_this_minute }}/{{ api_health.stellar_expert_burst_limit }}
                    </div>
                    <small>calls/min ({{ api_health.stellar_expert_rate_delay }}s delay)</small>
                    {% if api_health.stellar_expert_last_call %}
                    <small style="display: block; margin-top: 4px;">Last: {{ api_health.stellar_expert_last_call|slice:":19" }}</small>
                    {% endif %}
                </div>
            </div>
            <div>
                <div class="stat-card" title="Shows if rate limiting is active. When enabled, requests are throttled to prevent API ban. Slow continuous retrieval ensures stable operation.">
                    <div class="stat-label">Rate Limiting Status</div>
                    <div class="stat-value" style="line-height: 1.1; font-size: 2.4rem; margin: 8px 0; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        {% if api_health.rate_limiting_enabled %}
                            <span class="health-indicator health-good"></span> ACTIVE
                        {% else %}
                            <span class="health-indicator health-danger"></span> DISABLED
                        {% endif %}
                    </div>
                    <small style="margin-top: 10px; line-height: 1.2;">
                        {% if api_health.rate_limiting_enabled %}
                        Slow continuous<br>retrieval enabled
                        {% else %}
                        ⚠️ No rate limiting<br>protection
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        
        <!-- BigQuery Cost Tracking -->
        <h3 class="section-title">
            BigQuery Cost Tracking
        </h3>
        <div class="dashboard-grid">
            <div>
                <div class="stat-card" title="Maximum cost allowed per BigQuery query. Queries exceeding this limit automatically fall back to free APIs.">
                    <div class="stat-label">Cost Limit</div>
                    <div class="stat-value">${{ bigquery_stats.cost_limit_usd }}</div>
                    <small>per query</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Maximum data scan size per query. Large historical queries may exceed this limit and use API fallback instead.">
                    <div class="stat-label">Size Limit</div>
                    <div class="stat-value">{{ bigquery_stats.size_limit_gb|floatformat:0 }} GB</div>
                    <small>max data scanned</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Estimated monthly BigQuery cost based on 7-day average processing rate. Helps forecast budget needs.">
                    <div class="stat-label">Est. Monthly Cost</div>
                    <div class="stat-value">${{ bigquery_stats.estimated_monthly_cost|floatformat:2 }}</div>
                    <small>based on 7-day avg</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Current pipeline operation mode. API_ONLY uses free APIs only. BIGQUERY_WITH_API_FALLBACK uses BigQuery with API fallback. BIGQUERY_ONLY uses BigQuery exclusively.">
                    <div class="stat-label">Pipeline Mode</div>
                    <div class="stat-value" style="font-size: 1.0rem; white-space: normal; word-wrap: break-word; line-height: 1.3;">
                        {% if bigquery_stats.bigquery_enabled %}
                            <span class="health-indicator health-good"></span>
                        {% else %}
                            <span class="health-indicator health-danger"></span>
                        {% endif %}
                        {{ bigquery_stats.pipeline_mode }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Triple-Pipeline Metrics -->
        <h3 class="section-title">
                    Triple-Pipeline Metrics
                </h3>
        <div class="dashboard-grid">
            <div>
                <div class="stat-card" title="Total accounts processed using BigQuery pipeline (fast path). Typically takes 50-90 seconds per account with comprehensive lineage data.">
                    <div class="stat-label">BigQuery Processed</div>
                    <div class="stat-value" style="color: #0BE784;">
                        <span id="bigquery-total">--</span>
                    </div>
                    <small>fast path (50-90s per account)</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Accounts that started with BigQuery but fell back to API pipeline due to cost guard limits. Ensures budget protection while maintaining data quality.">
                    <div class="stat-label">BigQuery + API Fallback</div>
                    <div class="stat-value" style="color: #ffc107;">
                        <span id="bigquery-fallback-total">--</span>
                    </div>
                    <small>cost guard blocked, used API</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Total accounts processed using API-only pipeline (reliable fallback). Takes 180-300 seconds per account using free APIs (Horizon + Stellar Expert).">
                    <div class="stat-label">API-Only Processed</div>
                    <div class="stat-value" style="color: #96DDF2;">
                        <span id="api-total">--</span>
                    </div>
                    <small>reliable fallback (180-300s)</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Total accounts processed using Stellar SDK pipeline (concurrent async). Processes 3-5 accounts simultaneously, completely free using native SDK.">
                    <div class="stat-label">SDK Processed</div>
                    <div class="stat-value" style="color: #a78bfa;">
                        <span id="sdk-total">--</span>
                    </div>
                    <small>free concurrent (2-3s per account)</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Total accounts processed across all pipelines (BigQuery + Fallback + API + SDK). Shows complete system throughput.">
                    <div class="stat-label">Total Accounts</div>
                    <div class="stat-value">
                        <span id="total-accounts">--</span>
                    </div>
                    <small>all pipelines combined</small>
                </div>
            </div>
        </div>
        <div class="dashboard-grid">
            <div>
                <div class="stat-card" title="Number of accounts processed via BigQuery pipeline in the last 24 hours. Tracks recent fast-path usage.">
                    <div class="stat-label">Last 24h - BigQuery</div>
                    <div class="stat-value" style="color: #0BE784;">
                        <span id="last-24h-bigquery">--</span>
                    </div>
                    <small>accounts processed</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Number of accounts that fell back to API pipeline in the last 24 hours. High numbers may indicate cost limit tuning needed.">
                    <div class="stat-label">Last 24h - Fallback</div>
                    <div class="stat-value" style="color: #ffc107;">
                        <span id="last-24h-fallback">--</span>
                    </div>
                    <small>accounts processed</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Number of accounts processed via API-only pipeline in the last 24 hours. Shows recent reliable fallback usage.">
                    <div class="stat-label">Last 24h - API Only</div>
                    <div class="stat-value" style="color: #96DDF2;">
                        <span id="last-24h-api">--</span>
                    </div>
                    <small>accounts processed</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Number of accounts processed via SDK pipeline in the last 24 hours. Shows recent concurrent async processing usage.">
                    <div class="stat-label">Last 24h - SDK</div>
                    <div class="stat-value" style="color: #a78bfa;">
                        <span id="last-24h-sdk">--</span>
                    </div>
                    <small>accounts processed</small>
                </div>
            </div>
        </div>

        <!-- Database Health -->
        <h3 class="section-title">
                    Database Health
                </h3>
        <div class="dashboard-grid">
            <div>
                <div class="stat-card" title="Total number of Stellar accounts stored in the search cache">
                    <div class="stat-label">Total Accounts</div>
                    <div class="stat-value">{{ db_stats.total_cached_accounts }}</div>
                    <small>in cache</small>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-info admin-link-btn" style="border-color: #96DDF2; color: #96DDF2;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Accounts updated within the last 12 hours (cache TTL). Data is current and doesn't need refreshing.">
                    <div class="stat-label">Fresh Records</div>
                    <div class="stat-value" style="color: #0BE784;">{{ db_stats.fresh_accounts }}</div>
                    <small>up to date</small>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-success admin-link-btn" style="border-color: #0BE784; color: #0BE784;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Accounts not updated in over 12 hours. Data may be outdated and should be refreshed from the blockchain.">
                    <div class="stat-label">Stale Records</div>
                    <div class="stat-value" style="color: #ffc107;">{{ db_stats.stale_accounts }}</div>
                    <small>needs refresh</small>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-warning admin-link-btn" style="border-color: #ffc107; color: #ffc107;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Accounts stuck in PENDING or PROCESSING status for over 30 minutes. These may require manual intervention or reset.">
                    <div class="stat-label">Stuck Records</div>
                    <div class="stat-value" style="color: #E5526F;">{{ db_stats.stuck_accounts }}</div>
                    <small>⚠️ requires attention</small>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-danger admin-link-btn" style="border-color: #E5526F; color: #E5526F;">
                        View in Admin
                    </a>
                </div>
            </div>
        </div>

        <!-- Processing Status -->
        <h3 class="section-title">
            Processing Status
        </h3>
        <div class="dashboard-grid">
            <div>
                <div class="stat-card" title="Accounts waiting to be processed by the pipeline. These are queued for lineage data collection.">
                    <div class="stat-label">Pending</div>
                    <div class="stat-value">{{ db_stats.pending_accounts }}</div>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-info admin-link-btn" style="border-color: #96DDF2; color: #96DDF2;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Accounts currently being processed by the pipeline. Data collection is in progress.">
                    <div class="stat-label">In Progress</div>
                    <div class="stat-value">{{ db_stats.in_progress_accounts }}</div>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-info admin-link-btn" style="border-color: #96DDF2; color: #96DDF2;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Accounts that have been fully processed. Lineage data collection is complete.">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value" style="color: #0BE784;">{{ db_stats.completed_accounts }}</div>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-success admin-link-btn" style="border-color: #0BE784; color: #0BE784;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Accounts flagged for re-processing due to errors or data changes.">
                    <div class="stat-label">Re-inquiry</div>
                    <div class="stat-value">{{ db_stats.re_inquiry_accounts }}</div>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-info admin-link-btn" style="border-color: #96DDF2; color: #96DDF2;">
                        View in Admin
                    </a>
                </div>
            </div>
        </div>

        <!-- Lineage Data Integrity -->
        <h3 class="section-title">
                    Lineage Data Integrity
                </h3>
        <div class="dashboard-grid">
            <div>
                <div class="stat-card" title="Total number of creator-child relationship records stored in the lineage table.">
                    <div class="stat-label">Total Lineage Records</div>
                    <div class="stat-value">{{ db_stats.total_lineage_records }}</div>
                    <a href="/admin/apiApp/stellarcreatoraccountlineage/" class="btn btn-sm btn-outline-info admin-link-btn" style="border-color: #96DDF2; color: #96DDF2;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Unique accounts that have at least one lineage relationship (creator or child) in the database.">
                    <div class="stat-label">Accounts with Lineage</div>
                    <div class="stat-value" style="color: #0BE784;">{{ db_stats.accounts_with_lineage }}</div>
                    <a href="/admin/apiApp/stellarcreatoraccountlineage/" class="btn btn-sm btn-outline-success admin-link-btn" style="border-color: #0BE784; color: #0BE784;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Accounts marked as complete in cache but missing lineage data. These may need reprocessing.">
                    <div class="stat-label">Orphan Accounts</div>
                    <div class="stat-value" style="{% if db_stats.orphan_accounts > 0 %}color: #ffc107;{% endif %}">
                        {{ db_stats.orphan_accounts }}
                    </div>
                    <small>cached without lineage</small>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-warning admin-link-btn" style="border-color: #ffc107; color: #ffc107;">
                        View in Admin
                    </a>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <h3 class="section-title">
                    Performance Metrics
                </h3>
        <div class="dashboard-grid">
            <div>
                <div class="stat-card" title="Average time (in minutes) to process an account from start to completion.">
                    <div class="stat-label">Avg Processing Time</div>
                    <div class="stat-value">{{ performance_stats.avg_processing_time_minutes|floatformat:1 }}</div>
                    <small>minutes</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="The shortest processing time for any completed account.">
                    <div class="stat-label">Fastest Account</div>
                    <div class="stat-value">
                        {% if performance_stats.fastest_account_minutes %}
                            {{ performance_stats.fastest_account_minutes|floatformat:1 }}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                    <small>minutes</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="The longest processing time for any completed account.">
                    <div class="stat-label">Slowest Account</div>
                    <div class="stat-value">
                        {% if performance_stats.slowest_account_minutes %}
                            {{ performance_stats.slowest_account_minutes|floatformat:1 }}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                    <small>minutes</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Total number of accounts processed in the last 24 hours.">
                    <div class="stat-label">Processed (24h)</div>
                    <div class="stat-value">{{ performance_stats.total_accounts_processed_24h }}</div>
                    <small>accounts</small>
                </div>
            </div>
        </div>

        <!-- System Health -->
        <h3 class="section-title">
                    System Health
                </h3>
        <div class="dashboard-grid">
            <div>
                <div class="stat-card" title="Status of the last cron job execution. SUCCESS/DONE indicates healthy operation. ERROR/FAILED requires investigation.">
                    <div class="stat-label">Cron Status</div>
                    <div class="stat-value" style="{% if cron_health.status == 'SUCCESS' or cron_health.status == 'DONE' %}color: #0BE784; font-size: 2.4rem; display: flex; align-items: center; justify-content: center; gap: 8px; line-height: 1.1;{% elif cron_health.status == 'ERROR' or cron_health.status == 'FAILED' %}color: #E5526F; font-size: 2.4rem; display: flex; align-items: center; justify-content: center; gap: 8px; line-height: 1.1;{% elif cron_health.status|length > 15 %}color: #ffc107; font-size: 0.95rem; line-height: 1.25; padding: 0 8px; text-align: left;{% else %}color: #ffc107; font-size: 2.4rem; display: flex; align-items: center; justify-content: center; gap: 8px; line-height: 1.1;{% endif %} margin: 8px 0;">
                        {% if cron_health.status == 'SUCCESS' or cron_health.status == 'DONE' %}
                            <span class="health-indicator health-good"></span> {{ cron_health.status }}
                        {% elif cron_health.status == 'ERROR' or cron_health.status == 'FAILED' %}
                            <span class="health-indicator health-danger"></span> {{ cron_health.status }}
                        {% elif cron_health.status|length > 15 %}
                            <span class="health-indicator health-warning" style="float: left; margin-right: 5px; margin-top: 3px;"></span>{{ cron_health.status|slice:":60"|wordwrap:18 }}
                        {% else %}
                            <span class="health-indicator health-warning"></span> {{ cron_health.status }}
                        {% endif %}
                    </div>
                    <small style="margin-top: 6px; font-size: 0.65rem;">Last run:<br>{% if cron_health.last_run %}{{ cron_health.last_run|slice:":19" }}{% else %}Never{% endif %}</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Total number of pipeline stage executions tracked. Each account processing creates multiple stage execution records for monitoring.">
                    <div class="stat-label">Stage Executions</div>
                    <div class="stat-value">{{ stage_health.total_stage_executions }}</div>
                    <small>total tracked</small>
                </div>
            </div>
            <div>
                <div class="stat-card" title="Number of pipeline stages that encountered errors during execution. Non-zero values require investigation in admin portal.">
                    <div class="stat-label">Failed Stages</div>
                    <div class="stat-value" style="{% if stage_health.failed_stages > 0 %}color: #E5526F;{% endif %}">
                        {{ stage_health.failed_stages }}
                    </div>
                    <small>requires investigation</small>
                    <a href="/admin/apiApp/stellaraccountstageexecution/" class="btn btn-sm btn-outline-danger admin-link-btn" style="border-color: #E5526F; color: #E5526F;">
                        View in Admin
                    </a>
                </div>
            </div>
        </div>

    </div>
  </div>

  <!-- Load required Bootstrap and BootstrapVue CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.1/dist/bootstrap-vue.min.css" crossorigin="anonymous">
  
  <!-- Load Vue followed by BootstrapVue -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.1/dist/bootstrap-vue.min.js" crossorigin="anonymous"></script>
  
  <script>
    // Register BootstrapVue with Vue
    Vue.use(BootstrapVue);
    
    var vm = new Vue({
        el: '#app',
        data: {
          query_account: '',
          network_toggle: true,
          network_selected: 'public',
        },
        methods: {
          async search() {
            if (this.query_account && this.query_account.trim()) {
              const searchUrl = `/search/?account=${encodeURIComponent(this.query_account)}&network=${this.network_selected}`;
              window.location.href = searchUrl;
            }
          },
          toggleNetwork() {
            this.network_selected = this.network_toggle ? 'public' : 'testnet'
          },
          async fetchPipelineStats() {
            try {
              const response = await fetch('/api/pipeline-stats/');
              if (!response.ok) {
                console.error('Failed to fetch pipeline stats:', response.status);
                return;
              }
              
              const data = await response.json();
              
              // Update DOM with pipeline statistics (with defensive guards)
              document.getElementById('bigquery-total').textContent = (data.bigquery_total || 0).toLocaleString();
              document.getElementById('bigquery-fallback-total').textContent = (data.bigquery_with_fallback_total || 0).toLocaleString();
              document.getElementById('api-total').textContent = (data.api_total || 0).toLocaleString();
              document.getElementById('sdk-total').textContent = (data.sdk_total || 0).toLocaleString();
              document.getElementById('total-accounts').textContent = (data.total_accounts || 0).toLocaleString();
              
              // Update last 24h stats (with defensive guards)
              document.getElementById('last-24h-bigquery').textContent = (data.last_24h?.bigquery || 0).toLocaleString();
              document.getElementById('last-24h-fallback').textContent = (data.last_24h?.bigquery_with_fallback || 0).toLocaleString();
              document.getElementById('last-24h-api').textContent = (data.last_24h?.api || 0).toLocaleString();
              document.getElementById('last-24h-sdk').textContent = (data.last_24h?.sdk || 0).toLocaleString();
            } catch (error) {
              console.error('Error fetching pipeline stats:', error);
            }
          }
        },
        mounted() {
          // Fetch triple-pipeline statistics on load
          this.fetchPipelineStats();
          // Auto-refresh every 30 seconds
          setInterval(() => {
            this.fetchPipelineStats();
          }, 30000);
        }
    });
  </script>
</body>
</html>
