{% load static %}

<!DOCTYPE html>
<html>
<head>
  <title>StellarMap Web - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" type="text/css" href="{% static 'webApp/css/frontend.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" crossorigin="anonymous">
  
  <style>
    /* Cyberpunk theme colors */
    .dashboard-container {
        padding: 10px;
        background: #261D45; /* Main cyberpunk purple background */
        min-height: 100vh;
        color: #96DDF2; /* Cyberpunk cyan text */
    }
    .stat-card {
        background: linear-gradient(135deg, #231B3D 0%, #1a1530 100%); /* Subtle gradient */
        border: 1px solid #3f2c70; /* Cyberpunk purple border */
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 8px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(150, 221, 242, 0.1), transparent);
        transition: left 0.5s ease;
    }
    .stat-card:hover::before {
        left: 100%;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        border-color: #96DDF2; /* Cyberpunk cyan on hover */
        box-shadow: 0 4px 20px rgba(150, 221, 242, 0.3), 0 0 15px rgba(150, 221, 242, 0.1);
    }
    .stat-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #96DDF2; /* Cyberpunk cyan for values */
        word-wrap: break-word;
        overflow-wrap: break-word;
        margin: 2px 0;
        text-shadow: 0 0 10px rgba(150, 221, 242, 0.3);
        position: relative;
        z-index: 1;
    }
    .stat-label {
        color: #c4b5fd; /* Light purple for labels */
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 0;
    }
    .stat-card small {
        display: block;
        word-wrap: break-word;
        overflow-wrap: break-word;
        color: #a78bfa; /* Muted purple for small text */
        font-size: 0.65rem;
        margin-top: 1px;
    }
    .admin-link-btn {
        margin-top: 4px;
        font-size: 0.6rem;
        padding: 2px 5px;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
    }
    .admin-link-btn:hover {
        transform: translateX(3px);
    }
    /* Override Bootstrap button hover states with cyberpunk colors */
    .btn-outline-info:hover,
    .btn-outline-info:focus,
    .btn-outline-info:active {
        background-color: rgba(150, 221, 242, 0.1) !important;
        border-color: #96DDF2 !important;
        color: #96DDF2 !important;
    }
    .btn-outline-success:hover,
    .btn-outline-success:focus,
    .btn-outline-success:active {
        background-color: rgba(11, 231, 132, 0.1) !important;
        border-color: #0BE784 !important;
        color: #0BE784 !important;
    }
    .btn-outline-warning:hover,
    .btn-outline-warning:focus,
    .btn-outline-warning:active {
        background-color: rgba(255, 193, 7, 0.1) !important;
        border-color: #ffc107 !important;
        color: #ffc107 !important;
    }
    .btn-outline-danger:hover,
    .btn-outline-danger:focus,
    .btn-outline-danger:active {
        background-color: rgba(229, 82, 111, 0.1) !important;
        border-color: #E5526F !important;
        color: #E5526F !important;
    }
    .section-title {
        color: #0BE784; /* Cyberpunk green accent */
        margin-bottom: 6px;
        margin-top: 8px;
        padding-bottom: 3px;
        border-bottom: 1px solid #3f2c70; /* Cyberpunk purple border */
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
        position: relative;
    }
    .section-title::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 60px;
        height: 2px;
        background: linear-gradient(90deg, #0BE784, transparent);
    }
    .health-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 4px;
        position: relative;
    }
    /* Keep original indicator colors */
    .health-good { 
        background-color: #0BE784; /* Cyberpunk green */
        box-shadow: 0 0 6px rgba(11, 231, 132, 0.6);
    }
    .health-warning { 
        background-color: #ffc107; /* Yellow */
        box-shadow: 0 0 6px rgba(255, 193, 7, 0.6);
        animation: pulse-warning 2s infinite;
    }
    .health-danger { 
        background-color: #E5526F; /* Cyberpunk red */
        box-shadow: 0 0 6px rgba(229, 82, 111, 0.6);
        animation: pulse-danger 1.5s infinite;
    }
    @keyframes pulse-warning {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    @keyframes pulse-danger {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
    }
    .alert-custom {
        background: linear-gradient(135deg, #100D23 0%, #1a1530 100%); /* Dark cyberpunk gradient */
        border-left: 3px solid #3f2c70; /* Accent border */
        border-top: 1px solid #3f2c70;
        border-right: 1px solid #3f2c70;
        border-bottom: 1px solid #3f2c70;
        color: #96DDF2; /* Cyberpunk cyan text */
        padding: 6px 10px;
        margin-bottom: 6px;
        font-size: 0.8rem;
        border-radius: 3px;
        position: relative;
    }
    .alert-custom.alert-warning {
        border-left-color: #ffc107;
    }
    .alert-custom.alert-danger {
        border-left-color: #E5526F;
    }
    .alert-custom.alert-success {
        border-left-color: #0BE784;
    }
    /* Reduce Bootstrap row gutters for tighter layout */
    .row {
        margin-left: -8px;
        margin-right: -8px;
    }
    .row > [class*="col-"] {
        padding-left: 8px;
        padding-right: 8px;
    }
  </style>
</head>
<body class="bg-color-261D45">
  <div id="app">
    <!-- Include shared search container and sidebar -->
    {% include 'webApp/search_container_include.html' %}

    <div class="dashboard-container">
        <h1 class="text-center mb-2" style="font-size: 1.4rem; margin-top: 0; text-shadow: 0 0 15px rgba(150, 221, 242, 0.4); font-weight: 600; letter-spacing: 1px;">
            System Dashboard
        </h1>
        
        <!-- Alerts and Recommendations -->
        <div class="row">
            <div class="col-12">
                <h3 class="section-title">
                    Alerts & Recommendations
                </h3>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                {% if db_stats.stuck_accounts > 0 %}
                <div class="alert alert-custom alert-warning">
                    <strong>Stuck Records Alert:</strong>
                    {{ db_stats.stuck_accounts }} accounts are stuck in processing. Check cron jobs and pipeline health.
                </div>
                {% endif %}
                
                {% if db_stats.orphan_accounts > 0 %}
                <div class="alert alert-custom alert-warning">
                    <strong>Data Integrity Warning:</strong>
                    {{ db_stats.orphan_accounts }} accounts in cache have no lineage data. Consider re-processing.
                </div>
                {% endif %}
                
                {% if stage_health.failed_stages > 0 %}
                <div class="alert alert-custom alert-danger">
                    <strong>Pipeline Failures:</strong>
                    {{ stage_health.failed_stages }} stage executions have failed. Check logs for error details.
                </div>
                {% endif %}
                
                {% if bigquery_stats.estimated_monthly_cost > 50 %}
                <div class="alert alert-custom alert-info">
                    <strong>Cost Alert:</strong>
                    Estimated monthly BigQuery cost is ${{ bigquery_stats.estimated_monthly_cost|floatformat:2 }}. 
                    Consider adjusting cost limits or reducing processing frequency.
                </div>
                {% endif %}
                
                {% if db_stats.stuck_accounts == 0 and db_stats.orphan_accounts == 0 and stage_health.failed_stages == 0 %}
                <div class="alert alert-custom alert-success">
                    <strong>All Systems Healthy:</strong>
                    No critical issues detected. System is operating normally.
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- BigQuery Cost Tracking -->
        <div class="row">
            <div class="col-12">
                <h3 class="section-title">
                    BigQuery Cost Tracking
                </h3>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Cost Limit</div>
                    <div class="stat-value">${{ bigquery_stats.cost_limit_usd }}</div>
                    <small>per query</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Size Limit</div>
                    <div class="stat-value">{{ bigquery_stats.size_limit_gb|floatformat:0 }} GB</div>
                    <small>max data scanned</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Est. Monthly Cost</div>
                    <div class="stat-value">${{ bigquery_stats.estimated_monthly_cost|floatformat:2 }}</div>
                    <small>based on 7-day avg</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Pipeline Mode</div>
                    <div class="stat-value" style="font-size: 1.2rem;">
                        {% if bigquery_stats.bigquery_enabled %}
                            <span class="health-indicator health-good"></span>
                        {% else %}
                            <span class="health-indicator health-danger"></span>
                        {% endif %}
                        {{ bigquery_stats.pipeline_mode|truncatechars:15 }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Health -->
        <div class="row">
            <div class="col-12">
                <h3 class="section-title">
                    Database Health
                </h3>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Total Accounts</div>
                    <div class="stat-value">{{ db_stats.total_cached_accounts }}</div>
                    <small>in cache</small>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-info admin-link-btn" style="border-color: #96DDF2; color: #96DDF2;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Fresh Records</div>
                    <div class="stat-value" style="color: #0BE784;">{{ db_stats.fresh_accounts }}</div>
                    <small>up to date</small>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-success admin-link-btn" style="border-color: #0BE784; color: #0BE784;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Stale Records</div>
                    <div class="stat-value" style="color: #ffc107;">{{ db_stats.stale_accounts }}</div>
                    <small>needs refresh</small>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-warning admin-link-btn" style="border-color: #ffc107; color: #ffc107;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Stuck Records</div>
                    <div class="stat-value" style="color: #E5526F;">{{ db_stats.stuck_accounts }}</div>
                    <small>⚠️ requires attention</small>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-danger admin-link-btn" style="border-color: #E5526F; color: #E5526F;">
                        View in Admin
                    </a>
                </div>
            </div>
        </div>

        <!-- Processing Status -->
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Pending</div>
                    <div class="stat-value">{{ db_stats.pending_accounts }}</div>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-info admin-link-btn" style="border-color: #96DDF2; color: #96DDF2;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">In Progress</div>
                    <div class="stat-value">{{ db_stats.in_progress_accounts }}</div>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-info admin-link-btn" style="border-color: #96DDF2; color: #96DDF2;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value" style="color: #0BE784;">{{ db_stats.completed_accounts }}</div>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-success admin-link-btn" style="border-color: #0BE784; color: #0BE784;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Re-inquiry</div>
                    <div class="stat-value">{{ db_stats.re_inquiry_accounts }}</div>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-info admin-link-btn" style="border-color: #96DDF2; color: #96DDF2;">
                        View in Admin
                    </a>
                </div>
            </div>
        </div>

        <!-- Lineage Data Integrity -->
        <div class="row">
            <div class="col-12">
                <h3 class="section-title">
                    Lineage Data Integrity
                </h3>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-label">Total Lineage Records</div>
                    <div class="stat-value">{{ db_stats.total_lineage_records }}</div>
                    <a href="/admin/apiApp/stellarcreatoraccountlineage/" class="btn btn-sm btn-outline-info admin-link-btn" style="border-color: #96DDF2; color: #96DDF2;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-label">Accounts with Lineage</div>
                    <div class="stat-value" style="color: #0BE784;">{{ db_stats.accounts_with_lineage }}</div>
                    <a href="/admin/apiApp/stellarcreatoraccountlineage/" class="btn btn-sm btn-outline-success admin-link-btn" style="border-color: #0BE784; color: #0BE784;">
                        View in Admin
                    </a>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-label">Orphan Accounts</div>
                    <div class="stat-value" style="{% if db_stats.orphan_accounts > 0 %}color: #ffc107;{% endif %}">
                        {{ db_stats.orphan_accounts }}
                    </div>
                    <small>cached without lineage</small>
                    <a href="/admin/apiApp/stellaraccountsearchcache/" class="btn btn-sm btn-outline-warning admin-link-btn" style="border-color: #ffc107; color: #ffc107;">
                        View in Admin
                    </a>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="row">
            <div class="col-12">
                <h3 class="section-title">
                    Performance Metrics
                </h3>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Avg Processing Time</div>
                    <div class="stat-value">{{ performance_stats.avg_processing_time_minutes|floatformat:1 }}</div>
                    <small>minutes</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Fastest Account</div>
                    <div class="stat-value">
                        {% if performance_stats.fastest_account_minutes %}
                            {{ performance_stats.fastest_account_minutes|floatformat:1 }}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                    <small>minutes</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Slowest Account</div>
                    <div class="stat-value">
                        {% if performance_stats.slowest_account_minutes %}
                            {{ performance_stats.slowest_account_minutes|floatformat:1 }}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                    <small>minutes</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Processed (24h)</div>
                    <div class="stat-value">{{ performance_stats.total_accounts_processed_24h }}</div>
                    <small>accounts</small>
                </div>
            </div>
        </div>

        <!-- System Health -->
        <div class="row">
            <div class="col-12">
                <h3 class="section-title">
                    System Health
                </h3>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-label">Cron Status</div>
                    <div class="stat-value" style="{% if cron_health.status == 'SUCCESS' or cron_health.status == 'DONE' %}color: #0BE784;{% elif cron_health.status == 'ERROR' or cron_health.status == 'FAILED' %}color: #E5526F;{% else %}color: #ffc107;{% endif %}">
                        {% if cron_health.status == 'SUCCESS' or cron_health.status == 'DONE' %}
                            <span class="health-indicator health-good"></span>
                        {% elif cron_health.status == 'ERROR' or cron_health.status == 'FAILED' %}
                            <span class="health-indicator health-danger"></span>
                        {% else %}
                            <span class="health-indicator health-warning"></span>
                        {% endif %}
                        {{ cron_health.status }}
                    </div>
                    <small>Last run: {% if cron_health.last_run %}{{ cron_health.last_run|slice:":19" }}{% else %}Never{% endif %}</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-label">Stage Executions</div>
                    <div class="stat-value">{{ stage_health.total_stage_executions }}</div>
                    <small>total tracked</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-label">Failed Stages</div>
                    <div class="stat-value" style="{% if stage_health.failed_stages > 0 %}color: #E5526F;{% endif %}">
                        {{ stage_health.failed_stages }}
                    </div>
                    <small>requires investigation</small>
                    <a href="/admin/apiApp/stellaraccountstageexecution/" class="btn btn-sm btn-outline-danger admin-link-btn" style="border-color: #E5526F; color: #E5526F;">
                        View in Admin
                    </a>
                </div>
            </div>
        </div>

    </div>
  </div>

  <!-- Load required Bootstrap and BootstrapVue CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.1/dist/bootstrap-vue.min.css" crossorigin="anonymous">
  
  <!-- Load Vue followed by BootstrapVue -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.1/dist/bootstrap-vue.min.js" crossorigin="anonymous"></script>
  
  <script>
    // Register BootstrapVue with Vue
    Vue.use(BootstrapVue);
    
    var vm = new Vue({
        el: '#app',
        data: {
          query_account: '',
          network_toggle: true,
          network_selected: 'public',
        },
        methods: {
          async search() {
            if (this.query_account && this.query_account.trim()) {
              const searchUrl = `/search/?account=${encodeURIComponent(this.query_account)}&network=${this.network_selected}`;
              window.location.href = searchUrl;
            }
          },
          toggleNetwork() {
            this.network_selected = this.network_toggle ? 'public' : 'testnet'
          }
        }
    });
  </script>
</body>
</html>
