{% load static %}

<!DOCTYPE html>
<html>
<head>
  <title>StellarMap Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- include custom theme -->
  <link rel="stylesheet" type="text/css" href="{% static 'webApp/css/frontend.css' %}">
  <!-- include the Font Awesome library for the search icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" crossorigin="anonymous">
  <!-- include HighlightJS library for the terminal text fields -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/monokai-sublime.min.css" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js" crossorigin="anonymous"></script>
</head>
<body class="bg-color-261D45">
  <div id="app">
    <div class="top-container">
      <!-- using the verbatim tag to avoid conflicts between Django and Vue.js templates -->
      {% verbatim %}
        <div class="search-container">
          <!-- keeps the elements on the same line and responsive -->
          <div class="container-fluid">
            <!--  loading bar that is displayed while data is being fetched from the server -->
            <div>
              <b-progress v-if="loading" :value="progressValue" variant="danger" :animated="loading_animation" class="mt-3"></b-progress>
            </div>

            <!-- The sidebar menu allows users to access different pages,
                the network toggle allows users to switch between testnet and public Horizon servers,
                the input field allows users to enter their query, 
                and the search button initiates the search function. -->
            <div class="row align-items-center">
              <div class="col-auto">
                <b-button class="sidebar-button" v-b-toggle href="#sidebar-menu" @click.prevent><i class="fa fa-bars"></i></b-button>
              </div>
              <div class="col">
                <div class="row align-items-center">
                  <b-form-checkbox 
                    v-model="network_toggle" 
                    switch 
                    @change="toggleNetwork"
                    :class="{ 'text-red': !network_toggle, 'text-green': network_toggle }"
                  >{{network_selected}}</b-form-checkbox>
                  <input type="text" v-model="query_account" @keyup.enter="search" placeholder="Paste a Stellar account address...">
                </div>
              </div>
              <div class="col-auto">
                <button @click="search"><i class="fa fa-space-shuttle"></i></button>
              </div>
            </div>

          </div>
        </div>
      {% endverbatim %}
    </div>

    <!-- This element serves as a container for displaying the results of the search function -->
    <div class="results-container">
      {% if is_cached or is_refreshing %}
        <div class="cache-status-indicator" style="text-align: center; padding: 10px; margin-bottom: 10px;">
          {% if is_cached %}
            <span class="badge badge-success" style="font-size: 0.9em;">
              <i class="fas fa-clock"></i> Cached Data (Fresh)
            </span>
          {% elif is_refreshing %}
            <span class="badge badge-warning" style="font-size: 0.9em;">
              <i class="fas fa-sync fa-spin"></i> Refreshing Data...
            </span>
          {% endif %}
        </div>
      {% endif %}
      <div class="response-container">
        <div class="radial-tree-visual">
          {% include "radialTidyTreeApp/radial_tidy_tree_partial.html" %}
        </div>

        <div>
          <b-card no-body class="bv-tabs">
            <b-tabs card>
              <b-tab title="Account Lineage" active :title-link-attributes="{ title: 'View lineage table leading back to origin/creator accounts' }">
                <template>
                  <div v-if="lineageLoading" style="text-align: center; padding: 20px;">
                    <b-spinner variant="primary"></b-spinner>
                    <p>Loading account lineage...</p>
                  </div>
                  <div v-else-if="lineageError" class="alert alert-danger">
                    {% verbatim %}{{ lineageError }}{% endverbatim %}
                  </div>
                  <div v-else-if="account_lineage_data && account_lineage_data.length > 0">
                    <b-table
                      :items="account_lineage_data"
                      :fields="lineageTableFields"
                      striped
                      small
                      dark
                      hover
                    >
                      <template #cell(stellar_account)="data">
                        {% verbatim %}<span 
                          v-if="data.value"
                          style="font-family: monospace; font-size: 0.85em; cursor: pointer;"
                          :title="data.value"
                          @dblclick="copyToClipboard(data.value, 'Account address copied!')"
                        >...{{ data.value.slice(-6) }}</span>{% endverbatim %}
                        <span v-else class="text-muted">-</span>
                      </template>
                      <template #cell(stellar_creator_account)="data">
                        {% verbatim %}<span 
                          v-if="data.value"
                          style="font-family: monospace; font-size: 0.85em; cursor: pointer;"
                          :title="data.value"
                          @dblclick="copyToClipboard(data.value, 'Creator address copied!')"
                        >...{{ data.value.slice(-6) }}</span>{% endverbatim %}
                        <span v-else class="text-muted">-</span>
                      </template>
                      <template #cell(xlm_balance)="data">
                        {% verbatim %}{{ data.value ? data.value.toFixed(3) : '0.000' }} XLM{% endverbatim %}
                      </template>
                      <template #cell(stellar_account_created_at)="data">
                        {% verbatim %}<span v-if="data.value">{{ formatDateTimeEST(data.value) }}</span>{% endverbatim %}
                        <span v-else class="text-muted">-</span>
                      </template>
                      <template #cell(created_at)="data">
                        {% verbatim %}<span v-if="data.value">{{ formatDateTimeEST(data.value) }}</span>{% endverbatim %}
                        <span v-else class="text-muted">-</span>
                      </template>
                      <template #cell(updated_at)="data">
                        {% verbatim %}<span v-if="data.value">{{ formatDateTimeEST(data.value) }}</span>{% endverbatim %}
                        <span v-else class="text-muted">-</span>
                      </template>
                      <template #cell(home_domain)="data">
                        {% verbatim %}<a 
                          v-if="data.value && data.value.trim()"
                          href="#"
                          @click.prevent="showTomlContent(data.value)"
                          :title="'TOML: https://' + data.value + '/.well-known/stellar.toml'"
                          style="cursor: pointer; text-decoration: underline;"
                        >{{ data.value }}</a>{% endverbatim %}
                        <span v-else class="text-muted">-</span>
                      </template>
                      <template #cell(status)="data">
                        {% verbatim %}<b-badge :variant="getLineageStatusVariant(data.value)">{{ data.value }}</b-badge>{% endverbatim %}
                      </template>
                      <template #cell(actions)="row">
                        <b-button size="sm" variant="info" @click="showLineageJson(row.item)" title="View JSON">
                          <i class="fas fa-code"></i>
                        </b-button>
                      </template>
                    </b-table>
                  </div>
                  <div v-else class="alert alert-info">
                    No lineage data available for this address.
                  </div>
                </template>
              </b-tab>
              <b-tab title="JSON" :title-link-attributes="{ title: 'Raw JSON response data' }">
                <pre v-html="highlightedJSONResponse"></pre>
              </b-tab>
              <b-tab title="Search Cache" :title-link-attributes="{ title: 'Cache status and metadata for this search' }">
                <pre v-html="highlightedRequestStatus"></pre>
              </b-tab>
              <b-tab title="Pending Accounts" :title-link-attributes="{ title: 'Accounts currently being processed by the pipeline' }">
                <pre v-html="highlightedPendingAccounts"></pre>
              </b-tab>
              <b-tab title="Stages" :title-link-attributes="{ title: 'Real-time pipeline stage execution progress' }">
                <template>
                  <div v-if="stageExecutionsLoading" style="text-align: center; padding: 20px;">
                    <b-spinner variant="primary"></b-spinner>
                    <p>Loading stage executions...</p>
                  </div>
                  <div v-else-if="stageExecutionsError" class="alert alert-danger">
                    {{ stageExecutionsError }}
                  </div>
                  <div v-else-if="stage_executions_data && stage_executions_data.stages && stage_executions_data.stages.length > 0">
                    <b-table
                      :items="stage_executions_data.stages"
                      :fields="stageExecutionFields"
                      striped
                      small
                      dark
                      hover
                    >
                      <template #cell(status)="data">
                        <b-badge :variant="getStatusVariant(data.item.status)">{{ data.item.status }}</b-badge>
                      </template>
                      <template #cell(execution_time_seconds)="data">
                        {{ data.item.execution_time_seconds }}s
                      </template>
                      <template #cell(error_message)="data">
                        <span v-if="data.value" class="text-danger" v-text="truncateText(data.value, 50)"></span>
                        <span v-else class="text-success">No errors</span>
                      </template>
                      <template #cell(actions)="row">
                        <b-button size="sm" variant="info" @click="showStageJson(row.item)" title="View JSON">
                          <i class="fas fa-code"></i>
                        </b-button>
                      </template>
                    </b-table>
                    <div class="text-muted" style="font-size: 0.8em; margin-top: 10px;">
                      Auto-refreshes every 5 seconds
                    </div>
                  </div>
                  <div v-else class="alert alert-info">
                    No stage execution data available for this address. Stages will appear once processing begins.
                  </div>
                </template>
              </b-tab>
              <b-tab title="TOML" :title-link-attributes="{ title: 'Stellar TOML configuration files' }">
                <b-card-text>TOML outputs</b-card-text>
              </b-tab>
              <b-tab title="TERMINAL" :title-link-attributes="{ title: 'Terminal output and logs' }">
                <b-card-text>Terminal outputs</b-card-text>
              </b-tab>
            </b-tabs>
          </b-card>
        </div>

      </div>
    </div>
    
    <!-- The sidebar contains links and information that can be accessed by the user. -->
    <b-sidebar id="sidebar-menu" title="StellarMap.Network" shadow>
      <div class="px-3 py-2">
        This web application allows users to generate the lineage of Stellar addresses 
        and visualize them in a radial, tidy tree format. The tree maps address types 
        and activity, providing a clear and organized view of the relationships between addresses. 
      </div>

      <template #footer="{ hide }">
        <div class="d-flex text-light align-items-center px-3 py-2">
          <b-button class="close-button" @click="hide">
            <i class="fas fa-sign-out icon-pad"></i> Close
          </b-button>
        </div>
      </template>
    </b-sidebar>

    {% verbatim %}
    <!-- Stage JSON Viewer Modal -->
    <b-modal
      v-model="showStageJsonModal"
      title="Stage Execution Data"
      size="lg"
      ok-only
      ok-title="Close"
      header-bg-variant="dark"
      header-text-variant="light"
      body-bg-variant="dark"
      body-text-variant="light"
      footer-bg-variant="dark"
      footer-text-variant="light"
    >
      <div v-if="selectedStageData">
        <pre v-html="highlightedStageJSON" style="background-color: #23241f; padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto;"></pre>
      </div>
    </b-modal>

    <!-- Lineage JSON Viewer Modal -->
    <b-modal
      v-model="showLineageJsonModal"
      title="Account Lineage Data"
      size="lg"
      ok-only
      ok-title="Close"
      header-bg-variant="dark"
      header-text-variant="light"
      body-bg-variant="dark"
      body-text-variant="light"
      footer-bg-variant="dark"
      footer-text-variant="light"
    >
      <div v-if="selectedLineageData">
        <pre v-html="highlightedLineageJSON" style="background-color: #23241f; padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto;"></pre>
      </div>
    </b-modal>

    <!-- TOML Content Viewer Modal -->
    <b-modal
      v-model="showTomlModal"
      :title="tomlModalTitle"
      size="lg"
      ok-only
      ok-title="Close"
      header-bg-variant="dark"
      header-text-variant="light"
      body-bg-variant="dark"
      body-text-variant="light"
      footer-bg-variant="dark"
      footer-text-variant="light"
    >
      <div v-if="tomlLoading" class="text-center">
        <b-spinner variant="primary"></b-spinner>
        <p class="mt-3">Loading TOML content...</p>
      </div>
      <div v-else-if="tomlError" class="alert alert-danger">
        {{ tomlError }}
      </div>
      <div v-else-if="tomlContent">
        <pre style="background-color: #23241f; padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">{{ tomlContent }}</pre>
      </div>
    </b-modal>
    {% endverbatim %}
  </div>

  <!-- Load required Bootstrap and BootstrapVue CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.1/dist/bootstrap-vue.min.css" crossorigin="anonymous">
  <!-- Load Vue followed by BootstrapVue -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.1/dist/bootstrap-vue.min.js" crossorigin="anonymous"></script>
  <!-- Load D3.js for visualization -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js" crossorigin="anonymous"></script>
  <!-- Load tidytree.js for radial tree rendering -->
  <script src="{% static 'radialTidyTreeApp/d3-3.2.2/tidytree.js' %}"></script>
  <!-- Custom VueJS mixin -->
  {{ tree_data|json_script:"tree-data-json" }}
  {{ account_genealogy_items|json_script:"account-genealogy-json" }}
  {{ request_status_data|json_script:"request-status-json" }}
  {{ account_lineage_data|json_script:"account-lineage-json" }}
  {{ pending_accounts_data|json_script:"pending-accounts-json" }}
  
  <script src="{% static 'webApp/js/lineage_table_mixin.js' %}?v=2"></script>
  <script>
    const treeDataEl = document.getElementById('tree-data-json');
    const genealogyEl = document.getElementById('account-genealogy-json');
    const requestStatusEl = document.getElementById('request-status-json');
    const accountLineageEl = document.getElementById('account-lineage-json');
    const pendingAccountsEl = document.getElementById('pending-accounts-json');
    const parsedTreeData = JSON.parse(treeDataEl.textContent || '{}');
    const parsedRequestStatus = JSON.parse(requestStatusEl.textContent || '{}');
    const parsedAccountLineage = JSON.parse(accountLineageEl.textContent || '[]');
    const parsedPendingAccounts = JSON.parse(pendingAccountsEl.textContent || '[]');
    
    var vm = new Vue({
        el: '#app',
        mixins: [lineage_table_mixin],
        data: {
          query_account: '{{ account|default:"GD6WU64OEP5C4LRBH6NK3MHYIA2ADN6K6II6EXPNVUR3ERBXT4AN4ACD" }}',
          loading: false,
          progressValue: 0,
          response: '',
          highlightedJSONResponse: '',
          highlightedRequestStatus: '',
          highlightedAccountLineage: '',
          highlightedPendingAccounts: '',
          network_toggle: {% if network %}true{% else %}false{% endif %},
          network_selected: '{{ network|default:"testnet" }}',
          loading_animation: true,
          account_genealogy_items: JSON.parse(genealogyEl.textContent || '[]'),
          tree_data: parsedTreeData,
          request_status_data: parsedRequestStatus,
          account_lineage_data: parsedAccountLineage,
          pending_accounts_data: parsedPendingAccounts,
          pendingAccountsInterval: null,
          stage_executions_data: { stages: [] },
          stageExecutionsLoading: false,
          stageExecutionsError: null,
          stageExecutionsInterval: null,
          lineageLoading: false,
          lineageError: null,
          lineageInterval: null,
          stageExecutionFields: [
            { key: 'stage_number', label: 'Stage', sortable: true },
            { key: 'cron_name', label: 'Cron Job', sortable: true },
            { key: 'status', label: 'Status', sortable: true },
            { key: 'execution_time_seconds', label: 'Time', sortable: true },
            { key: 'error_message', label: 'Error', sortable: false },
            { key: 'actions', label: 'JSON', sortable: false }
          ],
          lineageTableFields: [
            { key: 'stellar_account', label: 'Account', sortable: true },
            { key: 'stellar_creator_account', label: 'Creator Account', sortable: true },
            { key: 'network_name', label: 'Network', sortable: true },
            { key: 'stellar_account_created_at', label: 'Account Created', sortable: true },
            { key: 'home_domain', label: 'Home Domain', sortable: true },
            { key: 'xlm_balance', label: 'XLM Balance', sortable: true },
            { key: 'status', label: 'Status', sortable: true },
            { key: 'created_at', label: 'Pipeline Created', sortable: true },
            { key: 'updated_at', label: 'Pipeline Updated', sortable: true },
            { key: 'actions', label: 'JSON', sortable: false }
          ],
          showStageJsonModal: false,
          selectedStageData: null,
          highlightedStageJSON: '',
          showLineageJsonModal: false,
          selectedLineageData: null,
          highlightedLineageJSON: '',
          showTomlModal: false,
          tomlModalTitle: '',
          tomlContent: '',
          tomlLoading: false,
          tomlError: null
        },
      methods: {
        async search() {
          // Set 'loading' to true to show a loading indicator
          this.loading = true;
          this.progressValue = 17;
          
          try {
            // Use Django backend for efficient search with caching and validation
            const searchUrl = `/search/?account=${encodeURIComponent(this.query_account)}&network=${this.network_selected}`;
            window.location.href = searchUrl;
          } catch (e) {
            // If an error occurs, store the error message in 'response'
            this.response = e.message;
            this.loading = false;
          }
        },
        toggleNetwork() {
          // Method that toggles the value of 'network_selected' between 'testnet' and 'public'
          this.network_selected = this.network_toggle ? 'public' : 'testnet'
        },
        updateJSONDisplay() {
          let dataToDisplay = null;
          
          if (this.account_genealogy_items && this.account_genealogy_items.length > 0) {
            dataToDisplay = this.account_genealogy_items;
          } else if (this.tree_data && Object.keys(this.tree_data).length > 0) {
            dataToDisplay = this.tree_data;
          }
          
          if (dataToDisplay) {
            this.response = JSON.stringify(dataToDisplay, null, 2);
            try {
              if (typeof hljs !== 'undefined') {
                this.highlightedJSONResponse = hljs.highlight(this.response, {language: 'json'}).value;
              } else {
                this.highlightedJSONResponse = this.response;
              }
            } catch (e) {
              this.highlightedJSONResponse = this.response;
            }
          } else {
            this.response = '';
            this.highlightedJSONResponse = '';
          }
        },
        updateRequestStatusDisplay() {
          if (this.request_status_data && Object.keys(this.request_status_data).length > 0) {
            const statusJSON = JSON.stringify(this.request_status_data, null, 2);
            try {
              if (typeof hljs !== 'undefined') {
                this.highlightedRequestStatus = hljs.highlight(statusJSON, {language: 'json'}).value;
              } else {
                this.highlightedRequestStatus = statusJSON;
              }
            } catch (e) {
              this.highlightedRequestStatus = statusJSON;
            }
          } else {
            this.highlightedRequestStatus = '';
          }
        },
        updateAccountLineageDisplay() {
          if (this.account_lineage_data && this.account_lineage_data.length > 0) {
            const lineageJSON = JSON.stringify(this.account_lineage_data, null, 2);
            try {
              if (typeof hljs !== 'undefined') {
                this.highlightedAccountLineage = hljs.highlight(lineageJSON, {language: 'json'}).value;
              } else {
                this.highlightedAccountLineage = lineageJSON;
              }
            } catch (e) {
              this.highlightedAccountLineage = lineageJSON;
            }
          } else {
            this.highlightedAccountLineage = '';
          }
        },
        updatePendingAccountsDisplay() {
          const pendingJSON = JSON.stringify(this.pending_accounts_data || [], null, 2);
          try {
            if (typeof hljs !== 'undefined') {
              this.highlightedPendingAccounts = hljs.highlight(pendingJSON, {language: 'json'}).value;
            } else {
              this.highlightedPendingAccounts = pendingJSON;
            }
          } catch (e) {
            this.highlightedPendingAccounts = pendingJSON;
          }
        },
        async fetchPendingAccounts() {
          try {
            const response = await fetch('/api/pending-accounts/');
            if (response.ok) {
              const data = await response.json();
              this.pending_accounts_data = data;
            }
          } catch (e) {
            console.error('Error fetching pending accounts:', e);
          }
        },
        async fetchStageExecutions() {
          if (!this.query_account || !this.network_selected) {
            return;
          }
          
          // Store scroll position before update
          const scrollPosition = window.scrollY;
          const isFirstLoad = this.stageExecutionsLoading && !this.stage_executions_data.stages;
          
          try {
            // Only show loading spinner on first load
            if (isFirstLoad) {
              this.stageExecutionsLoading = true;
            }
            this.stageExecutionsError = null;
            
            const url = `/api/stage-executions/?account=${encodeURIComponent(this.query_account)}&network=${encodeURIComponent(this.network_selected)}`;
            const response = await fetch(url);
            
            if (response.ok) {
              const data = await response.json();
              this.stage_executions_data = data;
              console.log('Stage data received:', data); // Debug log
            } else {
              const error = await response.json();
              this.stageExecutionsError = error.message || 'Failed to fetch stage executions';
            }
          } catch (e) {
            console.error('Error fetching stage executions:', e);
            this.stageExecutionsError = 'Error fetching stage executions';
          } finally {
            this.stageExecutionsLoading = false;
            // Restore scroll position after DOM update
            this.$nextTick(() => {
              window.scrollTo(0, scrollPosition);
            });
          }
        },
        async fetchAccountLineage() {
          if (!this.query_account || !this.network_selected) {
            return;
          }
          
          // Store scroll position before update
          const scrollPosition = window.scrollY;
          const isFirstLoad = !this.account_lineage_data || this.account_lineage_data.length === 0;
          
          try {
            // Only show loading spinner on first load
            if (isFirstLoad) {
              this.lineageLoading = true;
            }
            this.lineageError = null;
            
            const url = `/api/account-lineage/?account=${encodeURIComponent(this.query_account)}&network=${encodeURIComponent(this.network_selected)}`;
            const response = await fetch(url);
            
            if (response.ok) {
              const data = await response.json();
              this.account_lineage_data = data.lineage;
              console.log('Lineage data received:', data); // Debug log
            } else {
              const error = await response.json();
              this.lineageError = error.message || 'Failed to fetch account lineage';
            }
          } catch (e) {
            console.error('Error fetching account lineage:', e);
            this.lineageError = 'Error fetching account lineage';
          } finally {
            this.lineageLoading = false;
            // Restore scroll position after DOM update
            this.$nextTick(() => {
              window.scrollTo(0, scrollPosition);
            });
          }
        },
        getStatusVariant(status) {
          if (status === 'SUCCESS') return 'success';
          if (status === 'FAILED' || status === 'ERROR') return 'danger';
          if (status === 'TIMEOUT') return 'warning';
          return 'secondary';
        },
        truncateText(text, length) {
          if (!text) return '';
          if (text.length <= length) return text;
          return text.substring(0, length) + '...';
        },
        showStageJson(stageData) {
          this.selectedStageData = stageData;
          const stageJSON = JSON.stringify(stageData, null, 2);
          try {
            if (typeof hljs !== 'undefined') {
              this.highlightedStageJSON = hljs.highlight(stageJSON, {language: 'json'}).value;
            } else {
              this.highlightedStageJSON = stageJSON;
            }
          } catch (e) {
            this.highlightedStageJSON = stageJSON;
          }
          this.showStageJsonModal = true;
        },
        showLineageJson(lineageData) {
          this.selectedLineageData = lineageData;
          const lineageJSON = JSON.stringify(lineageData, null, 2);
          try {
            if (typeof hljs !== 'undefined') {
              this.highlightedLineageJSON = hljs.highlight(lineageJSON, {language: 'json'}).value;
            } else {
              this.highlightedLineageJSON = lineageJSON;
            }
          } catch (e) {
            this.highlightedLineageJSON = lineageJSON;
          }
          this.showLineageJsonModal = true;
        },
        getLineageStatusVariant(status) {
          if (status === 'COMPLETED_SUCCESS') return 'success';
          if (status === 'FAILED' || status === 'ERROR') return 'danger';
          if (status === 'PENDING_HORIZON_API_DATASETS') return 'warning';
          if (status && status.includes('PENDING')) return 'info';
          return 'secondary';
        },
        formatDateTimeEST(dateString) {
          if (!dateString) return '-';
          
          try {
            const date = new Date(dateString);
            
            // Format to NY EST timezone
            const options = {
              timeZone: 'America/New_York',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: false
            };
            
            return date.toLocaleString('en-US', options);
          } catch (e) {
            console.error('Error formatting date:', e);
            return dateString;
          }
        },
        copyToClipboard(text, message = 'Copied to clipboard!') {
          if (!text) return;
          
          // Use the modern Clipboard API if available
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
              this.$bvToast.toast(message, {
                title: 'Success',
                variant: 'success',
                solid: true,
                autoHideDelay: 2000
              });
            }).catch(err => {
              console.error('Failed to copy:', err);
              this.fallbackCopyToClipboard(text, message);
            });
          } else {
            this.fallbackCopyToClipboard(text, message);
          }
        },
        fallbackCopyToClipboard(text, message) {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          document.body.appendChild(textArea);
          textArea.select();
          
          try {
            document.execCommand('copy');
            this.$bvToast.toast(message, {
              title: 'Success',
              variant: 'success',
              solid: true,
              autoHideDelay: 2000
            });
          } catch (err) {
            console.error('Failed to copy:', err);
            this.$bvToast.toast('Failed to copy to clipboard', {
              title: 'Error',
              variant: 'danger',
              solid: true,
              autoHideDelay: 2000
            });
          }
          
          document.body.removeChild(textArea);
        },
        async showTomlContent(homeDomain) {
          if (!homeDomain) return;
          
          // Reset state
          this.tomlContent = '';
          this.tomlError = null;
          this.tomlLoading = true;
          this.tomlModalTitle = `Stellar TOML: ${homeDomain}`;
          this.showTomlModal = true;
          
          const proxyUrl = `/api/fetch-toml/?domain=${encodeURIComponent(homeDomain)}`;
          
          try {
            const response = await fetch(proxyUrl);
            const data = await response.json();
            
            if (!response.ok) {
              throw new Error(data.error || `Failed to fetch TOML: ${response.status}`);
            }
            
            this.tomlContent = data.content;
          } catch (error) {
            console.error('Error fetching TOML:', error);
            this.tomlError = `Failed to load TOML file for ${homeDomain}. ${error.message}`;
          } finally {
            this.tomlLoading = false;
          }
        }
      },
      watch: {
        account_genealogy_items: {
          handler(newVal) {
            // Update JSON display whenever account_genealogy_items changes
            this.updateJSONDisplay();
          },
          deep: true,
          immediate: true
        },
        tree_data: {
          handler(newVal) {
            // Update JSON display whenever tree_data changes
            this.updateJSONDisplay();
          },
          deep: true,
          immediate: true
        },
        request_status_data: {
          handler(newVal) {
            // Update request status display whenever request_status_data changes
            this.updateRequestStatusDisplay();
          },
          deep: true,
          immediate: true
        },
        account_lineage_data: {
          handler(newVal) {
            // Update account lineage display whenever account_lineage_data changes
            this.updateAccountLineageDisplay();
          },
          deep: true,
          immediate: true
        },
        pending_accounts_data: {
          handler(newVal) {
            // Update pending accounts display whenever pending_accounts_data changes
            this.updatePendingAccountsDisplay();
          },
          deep: true,
          immediate: true
        }
      },
      mounted() {
        // Initialize based on URL parameters if available
        const urlParams = new URLSearchParams(window.location.search);
        const accountParam = urlParams.get('account');
        const networkParam = urlParams.get('network');
        
        if (accountParam) {
          this.query_account = accountParam;
        }
        if (networkParam) {
          this.network_selected = networkParam;
          this.network_toggle = networkParam === 'public';
        }
        
        // Fetch pending accounts immediately on mount
        this.fetchPendingAccounts();
        
        // Set up auto-refresh for pending accounts every 5 seconds
        this.pendingAccountsInterval = setInterval(() => {
          this.fetchPendingAccounts();
        }, 5000);
        
        // Fetch stage executions immediately if account is available
        if (this.query_account && this.network_selected) {
          this.fetchStageExecutions();
          
          // Set up auto-refresh for stage executions every 5 seconds
          this.stageExecutionsInterval = setInterval(() => {
            this.fetchStageExecutions();
          }, 5000);
          
          // Fetch account lineage immediately on mount
          this.fetchAccountLineage();
          
          // Set up auto-refresh for account lineage every 5 seconds
          this.lineageInterval = setInterval(() => {
            this.fetchAccountLineage();
          }, 5000);
        }
        
        // JSON display is automatically updated by the watcher
      },
      beforeDestroy() {
        // Clean up intervals when component is destroyed
        if (this.pendingAccountsInterval) {
          clearInterval(this.pendingAccountsInterval);
        }
        if (this.stageExecutionsInterval) {
          clearInterval(this.stageExecutionsInterval);
        }
        if (this.lineageInterval) {
          clearInterval(this.lineageInterval);
        }
      }
    })
  </script>
</body>
</html>