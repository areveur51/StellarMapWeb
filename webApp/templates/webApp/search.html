{% load static %}

<!DOCTYPE html>
<html>
<head>
  <title>StellarMap Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- include custom theme -->
  <link rel="stylesheet" type="text/css" href="{% static 'webApp/css/frontend.css' %}">
  <!-- include the Font Awesome library for the search icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" crossorigin="anonymous">
  <!-- include HighlightJS library for the terminal text fields -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/monokai-sublime.min.css" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js" crossorigin="anonymous"></script>
</head>
<body class="bg-color-261D45">
  <div id="app">
    <div class="top-container">
      <!-- using the verbatim tag to avoid conflicts between Django and Vue.js templates -->
      {% verbatim %}
        <div class="search-container">
          <!-- keeps the elements on the same line and responsive -->
          <div class="container-fluid">
            <!--  loading bar that is displayed while data is being fetched from the server -->
            <div>
              <b-progress v-if="loading" :value="progressValue" variant="danger" :animated="loading_animation" class="mt-3"></b-progress>
            </div>

            <!-- The sidebar menu allows users to access different pages,
                the network toggle allows users to switch between testnet and public Horizon servers,
                the input field allows users to enter their query, 
                and the search button initiates the search function. -->
            <div class="row align-items-center">
              <div class="col-auto">
                <b-button class="sidebar-button" v-b-toggle href="#sidebar-menu" @click.prevent><i class="fa fa-bars"></i></b-button>
              </div>
              <div class="col">
                <div class="row align-items-center">
                  <b-form-checkbox 
                    v-model="network_toggle" 
                    switch 
                    @change="toggleNetwork"
                    :class="{ 'text-red': !network_toggle, 'text-green': network_toggle }"
                  >{{network_selected}}</b-form-checkbox>
                  <input type="text" v-model="query_account" @keyup.enter="search" placeholder="Paste a Stellar account address...">
                </div>
              </div>
              <div class="col-auto">
                <button @click="search"><i class="fa fa-space-shuttle"></i></button>
              </div>
            </div>

          </div>
        </div>
      {% endverbatim %}
    </div>

    <!-- This element serves as a container for displaying the results of the search function -->
    <div class="results-container">
      {% if is_cached or is_refreshing %}
        <div class="cache-status-indicator" style="text-align: center; padding: 10px; margin-bottom: 10px;">
          {% if is_cached %}
            <span class="badge badge-success" style="font-size: 0.9em;">
              <i class="fas fa-clock"></i> Cached Data (Fresh)
            </span>
          {% elif is_refreshing %}
            <span class="badge badge-warning" style="font-size: 0.9em;">
              <i class="fas fa-sync fa-spin"></i> Refreshing Data...
            </span>
          {% endif %}
        </div>
      {% endif %}
      <div class="response-container">
        <div class="radial-tree-visual">
          {% include "radialTidyTreeApp/radial_tidy_tree_partial.html" %}
        </div>

        <div>
          <b-card no-body class="bv-tabs">
            <b-tabs card>
              <b-tab title="Upstream Creator Accounts" active>
                <template>
                  <div>
                    <b-table
                      id="table-transition-example"
                      :items="account_genealogy_items"
                      :fields="visibleGeneologyFields"
                      striped
                      small
                      primary-key="stellar_account"
                      dark
                      :tbody-transition-props="transProps"
                    ></b-table>
                  </div>
                </template>
              </b-tab>
              <b-tab title="JSON">
                <pre v-html="highlightedJSONResponse"></pre>
              </b-tab>
              <b-tab title="Search Cache">
                <pre v-html="highlightedRequestStatus"></pre>
              </b-tab>
              <b-tab title="Account Lineage">
                <pre v-html="highlightedAccountLineage"></pre>
              </b-tab>
              <b-tab title="Pending Accounts">
                <pre v-html="highlightedPendingAccounts"></pre>
              </b-tab>
              <b-tab title="Stages">
                <template>
                  <div v-if="stageExecutionsLoading" style="text-align: center; padding: 20px;">
                    <b-spinner variant="primary"></b-spinner>
                    <p>Loading stage executions...</p>
                  </div>
                  <div v-else-if="stageExecutionsError" class="alert alert-danger">
                    {{ stageExecutionsError }}
                  </div>
                  <div v-else-if="stage_executions_data && stage_executions_data.stages && stage_executions_data.stages.length > 0">
                    <b-table
                      :items="stage_executions_data.stages"
                      :fields="stageExecutionFields"
                      striped
                      small
                      dark
                      hover
                    >
                      <template #cell(status)="data">
                        <b-badge :variant="getStatusVariant(data.value)">{{ data.value }}</b-badge>
                      </template>
                      <template #cell(execution_time_seconds)="data">
                        {{ data.value }}s
                      </template>
                      <template #cell(error_message)="data">
                        <span v-if="data.value" class="text-danger" v-text="truncateText(data.value, 50)"></span>
                        <span v-else class="text-success">No errors</span>
                      </template>
                    </b-table>
                    <div class="text-muted" style="font-size: 0.8em; margin-top: 10px;">
                      Auto-refreshes every 5 seconds
                    </div>
                  </div>
                  <div v-else class="alert alert-info">
                    No stage execution data available for this address. Stages will appear once processing begins.
                  </div>
                </template>
              </b-tab>
              <b-tab title="TOML">
                <b-card-text>TOML outputs</b-card-text>
              </b-tab>
              <b-tab title="TERMINAL">
                <b-card-text>Terminal outputs</b-card-text>
              </b-tab>
            </b-tabs>
          </b-card>
        </div>

      </div>
    </div>
    
    <!-- The sidebar contains links and information that can be accessed by the user. -->
    <b-sidebar id="sidebar-menu" title="StellarMap.Network" shadow>
      <div class="px-3 py-2">
        This web application allows users to generate the lineage of Stellar addresses 
        and visualize them in a radial, tidy tree format. The tree maps address types 
        and activity, providing a clear and organized view of the relationships between addresses. 
      </div>

      <template #footer="{ hide }">
        <div class="d-flex text-light align-items-center px-3 py-2">
          <b-button class="close-button" @click="hide">
            <i class="fas fa-sign-out icon-pad"></i> Close
          </b-button>
        </div>
      </template>
    </b-sidebar>
  </div>

  <!-- Load required Bootstrap and BootstrapVue CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.1/dist/bootstrap-vue.min.css" crossorigin="anonymous">
  <!-- Load Vue followed by BootstrapVue -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.1/dist/bootstrap-vue.min.js" crossorigin="anonymous"></script>
  <!-- Load D3.js for visualization -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js" crossorigin="anonymous"></script>
  <!-- Load tidytree.js for radial tree rendering -->
  <script src="{% static 'radialTidyTreeApp/d3-3.2.2/tidytree.js' %}"></script>
  <!-- Custom VueJS mixin -->
  {{ tree_data|json_script:"tree-data-json" }}
  {{ account_genealogy_items|json_script:"account-genealogy-json" }}
  {{ request_status_data|json_script:"request-status-json" }}
  {{ account_lineage_data|json_script:"account-lineage-json" }}
  {{ pending_accounts_data|json_script:"pending-accounts-json" }}
  
  <script src="{% static 'webApp/js/lineage_table_mixin.js' %}?v=2"></script>
  <script>
    const treeDataEl = document.getElementById('tree-data-json');
    const genealogyEl = document.getElementById('account-genealogy-json');
    const requestStatusEl = document.getElementById('request-status-json');
    const accountLineageEl = document.getElementById('account-lineage-json');
    const pendingAccountsEl = document.getElementById('pending-accounts-json');
    const parsedTreeData = JSON.parse(treeDataEl.textContent || '{}');
    const parsedRequestStatus = JSON.parse(requestStatusEl.textContent || '{}');
    const parsedAccountLineage = JSON.parse(accountLineageEl.textContent || '[]');
    const parsedPendingAccounts = JSON.parse(pendingAccountsEl.textContent || '[]');
    
    var vm = new Vue({
        el: '#app',
        mixins: [lineage_table_mixin],
        data: {
          query_account: '{{ account|default:"GD6WU64OEP5C4LRBH6NK3MHYIA2ADN6K6II6EXPNVUR3ERBXT4AN4ACD" }}',
          loading: false,
          progressValue: 0,
          response: '',
          highlightedJSONResponse: '',
          highlightedRequestStatus: '',
          highlightedAccountLineage: '',
          highlightedPendingAccounts: '',
          network_toggle: {% if network %}true{% else %}false{% endif %},
          network_selected: '{{ network|default:"testnet" }}',
          loading_animation: true,
          account_genealogy_items: JSON.parse(genealogyEl.textContent || '[]'),
          tree_data: parsedTreeData,
          request_status_data: parsedRequestStatus,
          account_lineage_data: parsedAccountLineage,
          pending_accounts_data: parsedPendingAccounts,
          pendingAccountsInterval: null,
          stage_executions_data: { stages: [] },
          stageExecutionsLoading: false,
          stageExecutionsError: null,
          stageExecutionsInterval: null,
          stageExecutionFields: [
            { key: 'stage_number', label: 'Stage', sortable: true },
            { key: 'cron_name', label: 'Cron Job', sortable: true },
            { key: 'status', label: 'Status', sortable: true },
            { key: 'execution_time_seconds', label: 'Time', sortable: true },
            { key: 'error_message', label: 'Error', sortable: false }
          ]
        },
      methods: {
        async search() {
          // Set 'loading' to true to show a loading indicator
          this.loading = true;
          this.progressValue = 17;
          
          try {
            // Use Django backend for efficient search with caching and validation
            const searchUrl = `/search/?account=${encodeURIComponent(this.query_account)}&network=${this.network_selected}`;
            window.location.href = searchUrl;
          } catch (e) {
            // If an error occurs, store the error message in 'response'
            this.response = e.message;
            this.loading = false;
          }
        },
        toggleNetwork() {
          // Method that toggles the value of 'network_selected' between 'testnet' and 'public'
          this.network_selected = this.network_toggle ? 'public' : 'testnet'
        },
        updateJSONDisplay() {
          let dataToDisplay = null;
          
          if (this.account_genealogy_items && this.account_genealogy_items.length > 0) {
            dataToDisplay = this.account_genealogy_items;
          } else if (this.tree_data && Object.keys(this.tree_data).length > 0) {
            dataToDisplay = this.tree_data;
          }
          
          if (dataToDisplay) {
            this.response = JSON.stringify(dataToDisplay, null, 2);
            try {
              if (typeof hljs !== 'undefined') {
                this.highlightedJSONResponse = hljs.highlight(this.response, {language: 'json'}).value;
              } else {
                this.highlightedJSONResponse = this.response;
              }
            } catch (e) {
              this.highlightedJSONResponse = this.response;
            }
          } else {
            this.response = '';
            this.highlightedJSONResponse = '';
          }
        },
        updateRequestStatusDisplay() {
          if (this.request_status_data && Object.keys(this.request_status_data).length > 0) {
            const statusJSON = JSON.stringify(this.request_status_data, null, 2);
            try {
              if (typeof hljs !== 'undefined') {
                this.highlightedRequestStatus = hljs.highlight(statusJSON, {language: 'json'}).value;
              } else {
                this.highlightedRequestStatus = statusJSON;
              }
            } catch (e) {
              this.highlightedRequestStatus = statusJSON;
            }
          } else {
            this.highlightedRequestStatus = '';
          }
        },
        updateAccountLineageDisplay() {
          if (this.account_lineage_data && this.account_lineage_data.length > 0) {
            const lineageJSON = JSON.stringify(this.account_lineage_data, null, 2);
            try {
              if (typeof hljs !== 'undefined') {
                this.highlightedAccountLineage = hljs.highlight(lineageJSON, {language: 'json'}).value;
              } else {
                this.highlightedAccountLineage = lineageJSON;
              }
            } catch (e) {
              this.highlightedAccountLineage = lineageJSON;
            }
          } else {
            this.highlightedAccountLineage = '';
          }
        },
        updatePendingAccountsDisplay() {
          const pendingJSON = JSON.stringify(this.pending_accounts_data || [], null, 2);
          try {
            if (typeof hljs !== 'undefined') {
              this.highlightedPendingAccounts = hljs.highlight(pendingJSON, {language: 'json'}).value;
            } else {
              this.highlightedPendingAccounts = pendingJSON;
            }
          } catch (e) {
            this.highlightedPendingAccounts = pendingJSON;
          }
        },
        async fetchPendingAccounts() {
          try {
            const response = await fetch('/api/pending-accounts/');
            if (response.ok) {
              const data = await response.json();
              this.pending_accounts_data = data;
            }
          } catch (e) {
            console.error('Error fetching pending accounts:', e);
          }
        },
        async fetchStageExecutions() {
          if (!this.query_account || !this.network_selected) {
            return;
          }
          
          try {
            this.stageExecutionsLoading = true;
            this.stageExecutionsError = null;
            
            const url = `/api/stage-executions/?account=${encodeURIComponent(this.query_account)}&network=${encodeURIComponent(this.network_selected)}`;
            const response = await fetch(url);
            
            if (response.ok) {
              const data = await response.json();
              this.stage_executions_data = data;
            } else {
              const error = await response.json();
              this.stageExecutionsError = error.message || 'Failed to fetch stage executions';
            }
          } catch (e) {
            console.error('Error fetching stage executions:', e);
            this.stageExecutionsError = 'Error fetching stage executions';
          } finally {
            this.stageExecutionsLoading = false;
          }
        },
        getStatusVariant(status) {
          if (status === 'SUCCESS') return 'success';
          if (status === 'FAILED' || status === 'ERROR') return 'danger';
          if (status === 'TIMEOUT') return 'warning';
          return 'secondary';
        },
        truncateText(text, length) {
          if (!text) return '';
          if (text.length <= length) return text;
          return text.substring(0, length) + '...';
        }
      },
      watch: {
        account_genealogy_items: {
          handler(newVal) {
            // Update JSON display whenever account_genealogy_items changes
            this.updateJSONDisplay();
          },
          deep: true,
          immediate: true
        },
        tree_data: {
          handler(newVal) {
            // Update JSON display whenever tree_data changes
            this.updateJSONDisplay();
          },
          deep: true,
          immediate: true
        },
        request_status_data: {
          handler(newVal) {
            // Update request status display whenever request_status_data changes
            this.updateRequestStatusDisplay();
          },
          deep: true,
          immediate: true
        },
        account_lineage_data: {
          handler(newVal) {
            // Update account lineage display whenever account_lineage_data changes
            this.updateAccountLineageDisplay();
          },
          deep: true,
          immediate: true
        },
        pending_accounts_data: {
          handler(newVal) {
            // Update pending accounts display whenever pending_accounts_data changes
            this.updatePendingAccountsDisplay();
          },
          deep: true,
          immediate: true
        }
      },
      mounted() {
        // Initialize based on URL parameters if available
        const urlParams = new URLSearchParams(window.location.search);
        const accountParam = urlParams.get('account');
        const networkParam = urlParams.get('network');
        
        if (accountParam) {
          this.query_account = accountParam;
        }
        if (networkParam) {
          this.network_selected = networkParam;
          this.network_toggle = networkParam === 'public';
        }
        
        // Fetch pending accounts immediately on mount
        this.fetchPendingAccounts();
        
        // Set up auto-refresh for pending accounts every 5 seconds
        this.pendingAccountsInterval = setInterval(() => {
          this.fetchPendingAccounts();
        }, 5000);
        
        // Fetch stage executions immediately if account is available
        if (this.query_account && this.network_selected) {
          this.fetchStageExecutions();
          
          // Set up auto-refresh for stage executions every 5 seconds
          this.stageExecutionsInterval = setInterval(() => {
            this.fetchStageExecutions();
          }, 5000);
        }
        
        // JSON display is automatically updated by the watcher
      },
      beforeDestroy() {
        // Clean up intervals when component is destroyed
        if (this.pendingAccountsInterval) {
          clearInterval(this.pendingAccountsInterval);
        }
        if (this.stageExecutionsInterval) {
          clearInterval(this.stageExecutionsInterval);
        }
      }
    })
  </script>
</body>
</html>